8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    15:41:04  11/14/;3  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  D:\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   LCD_INIT:far, MESSAGE_LCD:far, CLEAR_LCD:far, UPDATE_LCD_INPUT:far
                            20     extrn   set_timer2:far
                            21     
                            22     ;IO Setup for 80C188 
  FFA0                      23             UMCR    EQU    0FFA0H ; Upper Memory Control Register
  FFA2                      24             LMCR    EQU    0FFA2H ; Lower Memory control Register         
  FFA4                      25             PCSBA   EQU    0FFA4H ; Peripheral Chip Select Base Address
  FFA8                      26             MPCS    EQU    0FFA8H ; MMCS and PCS Alter Control Register
  FFA6                      27             MMCS    EQU    0FFA6H 
  0080                      28             A_8255  EQU    0080H
  0081                      29             B_8255  EQU    0081H
  0082                      30             C_8255  EQU    0082H
  0083                      31             CWR_8255  EQU    0083H
  FF38                      32             INT0CON  EQU   0FF38H
  FF22                      33             EOI EQU 0FF22H
  FF28                      34             IMASK EQU 0FF28H
  4000                      35             DAC EQU 4000H
                            36     
----                        37     STACK_SEG       SEGMENT
0000 (256                   38                     DB      256 DUP(?)
     ??
     )
0100                        39             TOS     LABEL   WORD
----                        40     STACK_SEG       ENDS
                            41     
                            42     
----                        43     DATA_SEG        SEGMENT
0000 0A                     44             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
     505420202020
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    15:41:04  11/14/;3  PAGE    2


LOC  OBJ                  LINE     SOURCE

0016 2F                     45             T_COUNT         DB      2FH
0017 2F                     46             T_COUNT_SET     DB      2FH
0018 0A                     47             REC_MESS        DB      10,13,'Period of timer0 =     '
0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D202020
     2020
0031 (32                    48             MESSAGE     DB  32 dup('h')
     68
     )
0051 20                     49             M_SIZE          DB  32
0052 00                     50             FLAG            DB  0
0053 ??                     51             CHAR            DB  ?
----                        52     DATA_SEG        ENDS
                            53     
----                        54     CODE_SEG        SEGMENT
                            55     
                            56             PUBLIC          START
                            57     
                            58     ASSUME  CS:CODE_SEG, SS:STACK_SEG
                            59     
0000                        60     START:
                            61     ;initialize stack area
0000 B8----         R       62                     MOV     AX,STACK_SEG            
0003 8ED0                   63                     MOV     SS,AX
0005 368B260001             64                     MOV     SP,TOS
                            65                     
000A B8----         R       66                     MOV AX, DATA_SEG
000D 8ED8                   67                     MOV DS, AX
                            68     
                            69     ; Initialize the on-chip pheripherals
000F 9A0000----     E       70                     CALL    FAR PTR IODEFINE
                            71                     
                            72     ;call set_timer2
0014 FB                     73                      STI
                            74     
                            75     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                            76     
                            77     ; Initialize LMCS 
0015 BAA2FF                 78         MOV DX, LMCR
0018 B8C401                 79         MOV AX, 01C4H  ; Starting address 1FFFH, 8K, No waits, last shoud be 5H for 1 wai
                                   ts      
001B EF                     80         OUT DX, AX
                            81        
                            82     ;Initialize MMCS
                            83             
001C BAA6FF                 84             MOV DX, MMCS
001F B80340                 85             MOV AX, 4003H
0022 EF                     86             OUT DX, AX
                            87     
                            88     ; Initialize MPCS to MAP peripheral to IO address
                            89             
0023 BAA8FF                 90             MOV DX, MPCS
0026 B88320                 91             MOV AX, 2083H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    15:41:04  11/14/;3  PAGE    3


LOC  OBJ                  LINE     SOURCE

0029 EF                     92             OUT DX, AX
                            93             
                            94     ; PCSBA initial, set the parallel port start from 00H
002A BAA4FF                 95             MOV DX, PCSBA
002D B80300                 96             MOV AX, 0003H ; Peripheral starting address 00H no READY, No Waits
0030 EF                     97             OUT DX, AX
                            98     
                            99                              
0031 BA8300                100             MOV DX, CWR_8255
0034 B88200                101             MOV AX, 0082h
0037 EF                    102             OUT DX, AX
                           103             
                           104             
                           105     ;       CALL FAR PTR LCD_INIT
0038 B80040                106     MOV AX, 4000H
003B 8ED8                  107     MOV DS, AX
003D BE0000                108     MOV SI, 0H
0040 BB0000                109     MOV BX, 0H
                           110     
                           111     
0043                       112     NEXT:
0043 33C0                  113     XOR AX, AX
0045 8A04                  114     MOV AL, [SI]
                           115     
                           116     
0047 BA1001                117     MOV DX, 110H
004A EE                    118     OUT DX, AL
                           119     
                           120     ;CALL FAR PTR PRINT_2HEX
                           121     ;125 us delay
004B B92D00                122                      MOV CX, 45
004E                       123                      loop125us:
004E 90                    124                      NOP
004F E2FD                  125                      LOOP loop125us
                           126             
                           127     ; CALL FAR PTR PRINT_2HEX
                           128     ; MOV AL, ' '
                           129     ; CALL FAR PTR PRINT_CHAR
                           130     
0051 46                    131     INC SI
0052 81FE0010              132     CMP SI, 1000H
0056 75EB                  133     JNE NEXT
0058 BE0000                134     MOV SI, 0H
                           135     ; MOV AX, DS
                           136     ; ADD AX, 1
                           137     ; MOV DS, AX
                           138     
                           139     ; CMP AX, 100
                           140     ; JNE NEXT
                           141     ; MOV AX, 100
                           142     ; MOV DS, AX
                           143     ; ;1s delay
                           144             ; MOV BX, 10
                           145             ; loop1sec:
                           146                      ; MOV CX, 910
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    15:41:04  11/14/;3  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           147                      ; loop125us2:
                           148                      ; NOP
                           149                      ; DEC CX
                           150                      ; JNZ loop125us2
                           151             ; DEC BX
                           152             ; JNZ loop1sec
                           153     
005B EBE6                  154     JMP NEXT
                           155     
                           156     
                           157     
                           158     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
005D                       159     SERIAL_REC_ACTION       PROC    FAR
005D 51                    160                     PUSH    CX
005E 53                    161                     PUSH    BX
005F 1E                    162                     PUSH    DS
                           163                     
0060 BB----         R      164                     MOV     BX,DATA_SEG             ;initialize data segment register
0063 8EDB                  165                     MOV     DS,BX
                           166                     
                           167                     ; CMP AL, '~'
                           168                     ; JNE resume
                           169                     
                           170                     ; CALL FAR PTR CLEAR_LCD
                           171                     ; JMP S_RET
                           172                     
                           173                     ; resume:
                           174                     ; CALL FAR PTR UPDATE_LCD_INPUT
                           175                     
0065                       176                     continue3:
                           177                     
0065 3C3C                  178                     CMP     AL,'<'
0067 750B                  179                     JNE     S_FAST
                           180     
0069 FE061700              181                     INC     DS:T_COUNT_SET
006D FE061700              182                     INC     DS:T_COUNT_SET
                           183     
0071 EB0D90                184                     JMP     S_NEXT0
0074                       185     S_FAST:
0074 3C3E                  186                     CMP     AL,'>'
0076 7521                  187                     JNE     S_RET
                           188     
0078 FE0E1700              189                     DEC     DS:T_COUNT_SET
007C FE0E1700              190                     DEC     DS:T_COUNT_SET
                           191     
0080                       192     S_NEXT0:
0080 B91600                193                     MOV     CX,22                   ;initialize counter for message
0083 BB0000                194                     MOV     BX,0
                           195     
0086 8A4718                196     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
0089 9A0000----     E      197                     call    FAR ptr print_char
008E 43                    198                     INC     BX
008F E2F5                  199                     LOOP    S_NEXT1
                           200     
0091 A01700                201                     MOV     AL,DS:T_COUNT_SET       ;print current period of timer0
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    15:41:04  11/14/;3  PAGE    5


LOC  OBJ                  LINE     SOURCE

0094 9A0000----     E      202                     CALL    FAR PTR PRINT_2HEX
0099                       203     S_RET:
0099 1F                    204                     POP     DS
009A 5B                    205                     POP     BX
009B 59                    206                     POP     CX
009C CB                    207                     RET
                           208     SERIAL_REC_ACTION       ENDP
                           209     
                           210     
                           211     
009D                       212     TIMER2_ACTION   PROC    FAR
009D 50                    213                     PUSH    AX
009E 1E                    214                     PUSH    DS
009F 53                    215                     PUSH    BX
00A0 51                    216                     PUSH    CX
                           217     
00A1 B8----         R      218                     MOV     AX,DATA_SEG
00A4 8ED8                  219                     MOV     DS,AX
                           220             
00A6 FE0E1600              221                     DEC     DS:T_COUNT
00AA 7516                  222                     JNZ     T_NEXT1
00AC A01700                223                     MOV     AL,DS:T_COUNT_SET
00AF A21600                224                     MOV     DS:T_COUNT,AL
                           225     
00B2 B91400                226                     MOV     CX,20
00B5 BB0000                227                     MOV     BX,0H
00B8                       228     T_NEXT0:
00B8 8A07                  229                     MOV     AL,DS:TIMER0_MESS[BX]
00BA 43                    230                     INC     BX
00BB 9A0000----     E      231                     CALL    FAR PTR PRINT_CHAR
00C0 E2F6                  232                     LOOP    T_NEXT0
                           233     
00C2                       234     T_NEXT1:        
00C2 59                    235                     POP     CX
00C3 5B                    236                     POP     BX
00C4 1F                    237                     POP     DS
00C5 58                    238                     POP     AX
00C6 CB                    239                     RET
                           240     TIMER2_ACTION   ENDP
                           241     
                           242     
----                       243     CODE_SEG        ENDS
                           244     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
