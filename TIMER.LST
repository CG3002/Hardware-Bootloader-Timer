8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  D:\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   LCD_INIT:far, MESSAGE_LCD:far, CLEAR_LCD:far, UPDATE_LCD_INPUT:far
                            20     extrn   set_timer2:far
                            21     
                            22     ;IO Setup for 80C188 
  FFA0                      23             UMCR    EQU    0FFA0H ; Upper Memory Control Register
  FFA2                      24             LMCR    EQU    0FFA2H ; Lower Memory control Register         
  FFA4                      25             PCSBA   EQU    0FFA4H ; Peripheral Chip Select Base Address
  FFA8                      26             MPCS    EQU    0FFA8H ; MMCS and PCS Alter Control Register
  0080                      27             A_8255  EQU    0080H
  0081                      28             B_8255  EQU    0081H
  0082                      29             C_8255  EQU    0082H
  0083                      30             CWR_8255  EQU    0083H
  FF38                      31             INT0CON  EQU   0FF38H
  FF22                      32             EOI EQU 0FF22H
  FF28                      33             IMASK EQU 0FF28H
  FFA6                      34             MMCS    EQU    0FFA6H 
  4000                      35             DAC EQU 4000H
                            36     
                            37     
----                        38     STACK_SEG       SEGMENT
0000 (512                   39                     DB      512 DUP(?)
     ??
     )
0200                        40             TOS     LABEL   WORD
----                        41     STACK_SEG       ENDS
                            42     
                            43     
----                        44     DATA_SEG        SEGMENT
0000 0A                     45             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    2


LOC  OBJ                  LINE     SOURCE

     505420202020
0016 18                     46             T_COUNT         DB      24
0017 18                     47             T_COUNT_SET     DB      24
0018 0A                     48             REC_MESS        DB      10,13,'Period of timer0 =     '
0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D202020
     2020
0031 (32                    49             MESSAGE     DB  32 dup('h')
     68
     )
0051 00                     50             KEYPAD_INPUT DB  0,0,0,0,0,0,0,0
0052 00
0053 00
0054 00
0055 00
0056 00
0057 00
0058 00
0059 2D                     51             BCD_MESSAGE DB  '-','-','-','-','-','-'
005A 2D
005B 2D
005C 2D
005D 2D
005E 2D
005F FE                     52             ENABLE_BYTE DB  11111110b
0060 00                     53             BCD_INDEX   DB  0
0061 0000                   54             KEYPAD_INDEX DW 0
0063 20                     55             M_SIZE          DB  32
0064 0040                   56             DAC_BASE    DW  4000H
0066 00                     57             DAC_ADDR    DB  0, 0, 0, 0, 0, 0, 0, 0, 0, 0 
0067 00
0068 00
0069 00
006A 00
006B 00
006C 00
006D 00
006E 00
006F 00
0070 00                     58             DAC_LEN     DB  0
0071 0000                   59             SI_PTR      DW  0
0073 ??                     60             CHAR            DB  ?
0074 ??                     61             REG_AL          DB  ?
0075 ??                     62             REG_BH          DB  ?
0076 ??                     63             REG_CL          DB  ?
0077 00                     64             FLAG        DB  0
0078 00                     65             LONG_PRESS_FLAG DB 0
0079 7231                   66             MY_ID           DB      'r1'
007B 00                     67             ID_FLAG_@               DB      0
007C 00                     68             ID_FLAG_r               DB      0
007D 4072312F               69             REPLY_MESSAGE   DB      '@r1/'
0081 40302F                 70             FAIL_MESSAGE DB '@0/'
0084 04                     71             REPLY_COUNT     DB      4
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    3


LOC  OBJ                  LINE     SOURCE

0085 03                     72             FAIL_COUNT      DB      3
0086 00                     73             REPLY_FLAG      DB      0
0087 00                     74             SEND_FLAG   DB  0
0088 (13                    75             SEND_BUFFER DB  13 dup(0)
     00
     )
0095 0000                   76             SEND_BUFFER_LEN DW 0
0097 0000                   77             MAX_INPUT_SIZE DW 0
0099 0000                   78             QTY_FLAG DW 0
----                        79     DATA_SEG        ENDS
                            80     
                            81     
----                        82     CODE_SEG        SEGMENT
                            83     
                            84             PUBLIC          START
                            85     
                            86     ASSUME  CS:CODE_SEG, SS:STACK_SEG
                            87     
0000                        88     START:
                            89     ;initialize stack area
0000 B8----         R       90                     MOV     AX,STACK_SEG            
0003 8ED0                   91                     MOV     SS,AX
0005 368B260002             92                     MOV     SP,TOS
                            93                     
                            94     ; Initialize the on-chip pheripherals
000A 9A0000----     E       95                     CALL    FAR PTR IODEFINE
                            96                     
000F 9A0000----     E       97     call set_timer2
0014 FB                     98                    STI
                            99     
                           100     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                           101     
                           102     ;Initialize MMCS
                           103             
0015 BAA6FF                104             MOV DX, MMCS
0018 B80340                105             MOV AX, 4003H
001B EF                    106             OUT DX, AX
                           107     
                           108     ; Initialize MPCS to MAP peripheral to IO address
                           109             
001C BAA8FF                110             MOV DX, MPCS
001F B88320                111             MOV AX, 2083H
0022 EF                    112             OUT DX, AX
                           113        
                           114     ; PCSBA initial, set the parallel port start from 00H
0023 BAA4FF                115             MOV DX, PCSBA
0026 B80300                116             MOV AX, 0003H ; Peripheral starting address 00H no READY, No Waits
0029 EF                    117             OUT DX, AX
                           118     
                           119     ; Initialize LMCS 
002A BAA2FF                120         MOV DX, LMCR
002D B8C401                121         MOV AX, 01C4H  ; Starting address 1FFFH, 8K, No waits, last shoud be 5H for 1 wai
                                   ts      
0030 EF                    122         OUT DX, AX
                           123             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    4


LOC  OBJ                  LINE     SOURCE

0031 B8----         R      124             MOV AX, DATA_SEG
0034 8ED8                  125             MOV DS, AX
                           126                              
0036 BA8300                127             MOV DX, CWR_8255
0039 B88200                128             MOV AX, 0082h
003C EF                    129             OUT DX, AX
                           130             
003D                       131     NEXT:
003D 9A4400----     R      132             CALL FAR PTR KEYPAD_LOOP
                           133             
0042 EBF9                  134     JMP NEXT
                           135     
0044                       136     KEYPAD_LOOP PROC FAR
0044 50                    137     PUSH AX
0045 53                    138     PUSH BX
0046 51                    139     PUSH CX
0047 52                    140     PUSH DX
                           141             
0048 9AE802----     R      142                             CALL FAR PTR DEBOUNCE           
                           143                             
004D C606740003            144     WAIT_1:         MOV DS:REG_AL, 03H
0052 BB0000                145                         MOV BX, 0000H
0055 BA8200                146                         MOV DX,C_8255
0058 8AC3                  147                         MOV AL,BL
005A EE                    148                         OUT DX,AL
                           149                        
005B BA8100                150                         MOV DX,B_8255
005E EC                    151                         IN AL,DX
005F 8AD8                  152                         MOV BL,AL  
0061 80E3FC                153                         AND BL,0FCH
0064 80FBFC                154                         CMP BL,0FCH
                           155                      
0067 7449                  156                     JE LONG_PRESS
                           157                             
0069 B3FE                  158                         MOV BL, 0FEH
006B C606750004            159                         MOV DS:REG_BH, 04H
                           160                        
0070                       161     NXTROW: 
0070 C0C307                162                     ROL BL,07H
0073 8AEB                  163                             MOV CH,BL
0075 BA8200                164                             MOV DX,C_8255
0078 8AC3                  165                             MOV AL,BL
007A EE                    166                             OUT DX,AL
                           167                             
007B BA8100                168                             MOV DX,B_8255
007E EC                    169                             IN AL,DX
007F 8AD8                  170                             MOV BL,AL
0081 80E3FC                171                             AND BL,0FCH
0084 C606760006            172                             MOV DS:REG_CL,06H
0089 C0DB02                173                             RCR BL,02H
008C D0DB                  174     NXTCOL:         RCR BL,01H
008E 732A                  175                             JNC CODEKY
0090 FE0E7400              176                             DEC DS:REG_AL
0094 FE0E7600              177                             DEC DS:REG_CL
0098 803E760003            178                             CMP DS:REG_CL,03H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    5


LOC  OBJ                  LINE     SOURCE

009D 745F                  179                             JE KEYPAD3
                           180                             
009F 803E760000            181                             CMP DS:REG_CL, 0H
00A4 7455                  182                             JE SUBTRACT2
00A6 EBE4                  183                             JMP NXTCOL
                           184                             
00A8 8ADD                  185                             MOV BL,CH
00AA FE0E7500              186                             DEC DS:REG_BH
00AE 75C0                  187                             JNZ NXTROW
00B0 EB9B                  188                             JMP WAIT_1
                           189                             
00B2                       190     LONG_PRESS:
00B2 C606780000            191                             MOV DS:LONG_PRESS_FLAG, 0
00B7 EB4890                192                             JMP RETURN2
00BA                       193     CODEKY:
00BA 803E74000B            194                         CMP DS:REG_AL, 11
00BF 7505                  195                             JNE bcd_upd
00C1 C606740000            196                             MOV DS:REG_AL, 0
                           197                             
00C6                       198     bcd_upd:
00C6 803E780000            199                             CMP DS:LONG_PRESS_FLAG, 0
00CB 7534                  200                             JNE RETURN2
                           201                             
00CD 803E74000A            202                             CMP DS:REG_AL, 10
00D2 7508                  203                             JNE BACKSPACE
00D4 9A4F02----     R      204                             CALL FAR PTR BCD_CLEAR
00D9 E98D00                205                             JMP UPDATE_7SEG
                           206                             
00DC 803E74000C            207     BACKSPACE:      CMP DS:REG_AL, 12
00E1 7508                  208                             JNE ENTER_DATA
00E3 9A1902----     R      209                             CALL FAR PTR BCD_BACKSPACE
00E8 EB7F90                210                             JMP UPDATE_7SEG
                           211     
00EB 803E74000D            212     ENTER_DATA:     CMP DS:REG_AL, 13
00F0 7512                  213                             JNE QTY_PROMPT
00F2 C70697000800          214                             MOV DS:MAX_INPUT_SIZE, 8
00F8 EB6F90                215                             JMP UPDATE_7SEG
                           216                             
00FB E98F00                217     SUBTRACT2:   JMP SUBTRACT
                           218     
00FE EB7D90                219     KEYPAD3:        JMP KEYPAD_2
                           220     
0101 E99700                221     RETURN2:    JMP RETURN
                           222     
0104                       223     QTY_PROMPT:
0104 833E610000            224                             CMP DS:KEYPAD_INDEX, 0
0109 7420                  225                             JE  QUANTITY
010B 803E740016            226                             CMP DS:REG_AL, 22
0110 7519                  227                             JNE QUANTITY
0112 9AD201----     R      228                             CALL FAR PTR UPDATE_SEND_BUFFER
0117 9A4F02----     R      229                             CALL FAR PTR BCD_CLEAR
011C C70697000200          230                             MOV DS:MAX_INPUT_SIZE, 2
0122 C70699000100          231                             MOV DS:QTY_FLAG, 1
0128 EB3F90                232                             JMP UPDATE_7SEG
                           233                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    6


LOC  OBJ                  LINE     SOURCE

012B                       234     QUANTITY:
012B 833E610000            235                             CMP DS:KEYPAD_INDEX, 0
0130 7437                  236                             JE  UPDATE_7SEG
                           237                             
0132 803E74000E            238                             CMP DS:REG_AL, 14
0137 7530                  239                             JNE UPDATE_7SEG
                           240                             
0139 833E990001            241                             CMP DS:QTY_FLAG, 1
013E 7529                  242                             JNE UPDATE_7SEG
                           243                             
0140 9AA001----     R      244                             CALL FAR PTR UPDATE_THE_QUANTITY
                           245                                             
0145 C606870001            246                             MOV DS:SEND_FLAG, 1
014A 9AF102----     R      247                             CALL FAR PTR SEND_INPUT
014F C70695000000          248                             MOV DS:SEND_BUFFER_LEN, 0
0155 C70697000000          249                             MOV DS:MAX_INPUT_SIZE, 0
015B C70699000000          250                             MOV DS:QTY_FLAG, 0
0161 9A4F02----     R      251                             CALL FAR PTR BCD_CLEAR
                           252                                     
0166 EB0190                253                             JMP UPDATE_7SEG
                           254                             
                           255     
0169                       256     UPDATE_7SEG:
0169 803E740009            257                             CMP DS:REG_AL, 9
016E 7F05                  258                             JG SET_PRESS_FLAG
                           259                             
0170 9A7402----     R      260                             CALL FAR PTR BCD_UPDATE
                           261                             
0175                       262     SET_PRESS_FLAG:
0175 C606780001            263                             MOV DS:LONG_PRESS_FLAG, 1
017A EB1F90                264                             JMP RETURN
                           265             
017D                       266     KEYPAD_2: 
017D 800674000F            267                 ADD DS:REG_AL,0FH
0182 E907FF                268                             JMP NXTCOL
0185 C606740000            269     ZERO_PRINT: MOV DS:REG_AL,00H
018A E9FFFE                270                             JMP NXTCOL
018D 802E740006            271     SUBTRACT:   SUB DS:REG_AL,06H
0192 8ADD                  272                             MOV BL,CH
0194 FE0E7500              273                             DEC DS:REG_BH
0198 E9D5FE                274                             JMP NXTROW
                           275             
                           276             
019B                       277     RETURN:
019B 5A                    278                             POP DX
019C 59                    279                             POP CX
019D 5B                    280                             POP BX
019E 58                    281                             POP AX
019F CB                    282                             RET
                           283     
                           284     KEYPAD_LOOP ENDP
                           285     
01A0                       286     UPDATE_THE_QUANTITY PROC FAR
01A0 50                    287     PUSH AX
01A1 53                    288     PUSH BX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    7


LOC  OBJ                  LINE     SOURCE

01A2 51                    289     PUSH CX
01A3 52                    290     PUSH DX
01A4 8B0E6100              291             MOV CX, DS:KEYPAD_INDEX
01A8 8B1E9500              292             MOV BX, DS:SEND_BUFFER_LEN
                           293             
01AC                       294             UPD_QTY:
01AC 53                    295                     PUSH BX
01AD 8B1E6100              296                     MOV BX, DS:KEYPAD_INDEX
01B1 2BD9                  297                     SUB BX, CX
01B3 8A4751                298                     MOV AL, DS:KEYPAD_INPUT[BX]
01B6 5B                    299                     POP BX
01B7 0430                  300                     ADD AL, 30H
01B9 88878800              301                     MOV DS:SEND_BUFFER[BX], AL
                           302                     
01BD 43                    303                     INC BX
01BE FF069500              304                     INC DS:SEND_BUFFER_LEN
                           305                     
01C2 E2E8                  306             LOOP UPD_QTY
01C4 C68788002F            307                     MOV DS:SEND_BUFFER[BX], '/'
01C9 FF069500              308                     INC DS:SEND_BUFFER_LEN
                           309     
01CD 5A                    310     POP DX
01CE 59                    311     POP CX
01CF 5B                    312     POP BX
01D0 58                    313     POP AX
                           314     
01D1 CB                    315     RET
                           316     UPDATE_THE_QUANTITY ENDP
                           317     
01D2                       318     UPDATE_SEND_BUFFER PROC FAR
01D2 50                    319     PUSH AX
01D3 53                    320     PUSH BX
01D4 51                    321     PUSH CX
01D5 52                    322     PUSH DX
                           323     
01D6 8B0E6100              324             MOV CX, DS:KEYPAD_INDEX
01DA 83F900                325             CMP CX, 0
01DD 7435                  326             JE END_UPD_BUFFER
01DF 83C102                327             ADD CX, 2
01E2 890E9500              328             MOV DS:SEND_BUFFER_LEN, CX
01E6 BB0000                329             MOV BX, 0
01E9                       330             BUFFER_LOOP:
01E9 83FB00                331                     CMP BX, 0
01EC 7508                  332                     JNE ASTRISK
01EE C68788007E            333                     MOV DS:SEND_BUFFER[BX], '~'
01F3 EB1C90                334                     JMP END_BUFFER
01F6                       335             ASTRISK:
01F6 A16100                336                     MOV AX, DS:KEYPAD_INDEX
01F9 40                    337                     INC AX
01FA 3BD8                  338                     CMP BX, AX
01FC 7508                  339                     JNE CONT
01FE C68788002A            340                     MOV DS:SEND_BUFFER[BX], '*'
0203 EB0C90                341                     JMP END_BUFFER
0206                       342             CONT:
0206 4B                    343                     DEC BX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    8


LOC  OBJ                  LINE     SOURCE

0207 8A4751                344                     MOV AL, DS:KEYPAD_INPUT[BX]
020A 0430                  345                     ADD AL, 30H
020C 43                    346                     INC BX
020D 88878800              347                     MOV DS:SEND_BUFFER[BX], AL
                           348                     
0211                       349             END_BUFFER:
0211 43                    350                     INC BX
0212 E2D5                  351             LOOP BUFFER_LOOP
0214                       352     END_UPD_BUFFER:
0214 5A                    353     POP DX
0215 59                    354     POP CX
0216 5B                    355     POP BX
0217 58                    356     POP AX
0218 CB                    357     RET
                           358     UPDATE_SEND_BUFFER ENDP
                           359     
0219                       360     BCD_BACKSPACE PROC FAR
                           361     
0219 50                    362     PUSH AX
021A 53                    363     PUSH BX
021B 51                    364     PUSH CX
021C 52                    365     PUSH DX
                           366     
021D 8A167400              367             MOV DL, DS:REG_AL
0221 833E610000            368             CMP DS:KEYPAD_INDEX, 0
0226 7422                  369             JE RETURN_BACK
                           370             
0228 BB0600                371             MOV BX, 6
022B                       372             BCD_CLEAR_LOOP:
022B 4B                    373                     DEC BX
022C C647592D              374                     MOV DS:BCD_MESSAGE[BX], '-'
0230 43                    375                     INC BX
0231 4B                    376                     DEC BX
0232 75F7                  377             JNZ BCD_CLEAR_LOOP
                           378             
0234 FF0E6100              379             DEC DS:KEYPAD_INDEX
0238 C60674002D            380             MOV DS:REG_AL, '-'
023D 9A7402----     R      381             CALL FAR PTR BCD_UPDATE
0242 FF0E6100              382             DEC DS:KEYPAD_INDEX
                           383             
0246 88167400              384             MOV DS:REG_AL, DL
024A                       385     RETURN_BACK:
024A 5A                    386     POP DX
024B 59                    387     POP CX
024C 5B                    388     POP BX
024D 58                    389     POP AX
                           390     
024E CB                    391     RET
                           392     BCD_BACKSPACE ENDP
                           393     
024F                       394     BCD_CLEAR PROC FAR
024F 50                    395     PUSH AX
0250 53                    396     PUSH BX
0251 51                    397     PUSH CX
0252 52                    398     PUSH DX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE    9


LOC  OBJ                  LINE     SOURCE

0253 BB0800                399             MOV BX, 8
0256                       400             CLEAR_LOOP:
0256 C6475100              401             MOV DS:KEYPAD_INPUT[BX], 0
025A 4B                    402             DEC BX
025B 75F9                  403             JNZ CLEAR_LOOP
                           404             
025D BB0600                405             MOV BX, 6
0260                       406             CLEAR_LOOP2:
0260 4B                    407                     DEC BX
0261 C647592D              408                     MOV DS:BCD_MESSAGE[BX], '-'
0265 43                    409                     INC BX
0266 4B                    410                     DEC BX
0267 75F7                  411             JNZ CLEAR_LOOP2
                           412     
0269 C70661000000          413             MOV DS:KEYPAD_INDEX, 0
026F 5A                    414     POP DX
0270 59                    415     POP CX
0271 5B                    416     POP BX
0272 58                    417     POP AX
0273 CB                    418     RET
                           419     BCD_CLEAR ENDP
                           420     
0274                       421     BCD_UPDATE PROC FAR
0274 50                    422     PUSH AX
0275 53                    423     PUSH BX
0276 51                    424     PUSH CX
0277 52                    425     PUSH DX
0278 A19700                426                     MOV AX, DS:MAX_INPUT_SIZE
027B 39066100              427                     CMP DS:KEYPAD_INDEX, AX
027F 7448                  428                     JE BCD_RET
                           429                     
0281 8A0E7400              430                     MOV CL, DS:REG_AL
0285 80F909                431                     CMP CL, 9
0288 7F05                  432                     JG SKIP_PAST
028A 9ACE02----     R      433                     CALL FAR PTR DAC_UPDATE
                           434     
028F                       435     SKIP_PAST:              
028F 8A0E7400              436                     MOV CL, DS:REG_AL
                           437     
0293 8B1E6100              438                     MOV BX, DS:KEYPAD_INDEX
                           439                             
0297 884F51                440                     MOV DS:KEYPAD_INPUT[BX], CL
                           441                             
029A FF066100              442                     INC DS:KEYPAD_INDEX
                           443                             
029E 8B1E6100              444                     MOV BX, DS:KEYPAD_INDEX
02A2 8BD3                  445                     MOV DX, BX
02A4 83FA06                446                     CMP DX, 6
02A7 7E03                  447                     JLE update_display
02A9 BA0600                448                     MOV DX, 6
                           449                     
02AC                       450             update_display:
                           451                             
02AC B90500                452                     MOV CX, 5
02AF 4B                    453                     DEC BX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   10


LOC  OBJ                  LINE     SOURCE

02B0 8A4751                454                     MOV AL, DS:KEYPAD_INPUT[BX]
02B3 43                    455                     INC BX
                           456                             
02B4 52                    457                     PUSH DX
02B5 8B166100              458                     MOV DX, DS:KEYPAD_INDEX
02B9 2BD3                  459                     SUB DX, BX
                           460                             
02BB 53                    461                     PUSH BX
                           462                             
02BC 2BCA                  463                     SUB CX, DX
02BE 8BD9                  464                     MOV BX, CX
02C0 884759                465                     MOV DS:BCD_MESSAGE[BX], AL
                           466                             
02C3 5B                    467                     POP BX
02C4 5A                    468                     POP DX
                           469             
02C5 4B                    470                     DEC BX
02C6 4A                    471                     DEC DX
02C7 75E3                  472                     JNZ update_display
                           473     
02C9                       474             BCD_RET:
02C9 5A                    475                     POP DX
02CA 59                    476                     POP CX
02CB 5B                    477                     POP BX
02CC 58                    478                     POP AX
02CD CB                    479     RET
                           480     BCD_UPDATE ENDP
                           481     
02CE                       482     DAC_UPDATE PROC FAR
02CE 50                    483             PUSH AX
02CF 53                    484             PUSH BX
02D0 51                    485             PUSH CX
02D1 52                    486             PUSH DX
                           487             
02D2 BB0000                488             MOV BX, 0
02D5 8A1E7000              489             MOV BL, DS:DAC_LEN
02D9 A07400                490             MOV AL, DS:REG_AL
                           491             
02DC 884766                492             MOV DS:DAC_ADDR[BX], AL
                           493             
02DF FE067000              494             INC DS:DAC_LEN
                           495     
02E3 5A                    496             POP DX
02E4 59                    497             POP CX
02E5 5B                    498             POP BX
02E6 58                    499             POP AX
02E7 CB                    500     RET
                           501     DAC_UPDATE ENDP
                           502               
02E8                       503     DEBOUNCE PROC FAR
02E8 51                    504                       PUSH CX
                           505                       
02E9 B94C09                506                       MOV CX, 094CH
02EC 90                    507     BACK:     NOP
02ED E2FD                  508                       LOOP BACK
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   11


LOC  OBJ                  LINE     SOURCE

02EF 59                    509                       POP CX
02F0 CB                    510                       RET
                           511     DEBOUNCE  ENDP
                           512     
02F1                       513     SEND_INPUT PROC FAR
02F1 50                    514     PUSH AX
02F2 53                    515     PUSH BX
02F3 51                    516     PUSH CX
02F4 52                    517     PUSH DX
02F5 BB0000                518             MOV BX, 0
02F8 8B0E9500              519             MOV CX, DS:SEND_BUFFER_LEN
                           520             
02FC                       521             S_BUFF:
02FC 8A878800              522                     MOV AL, DS:SEND_BUFFER[BX]
0300 9A0000----     E      523                     CALL FAR PTR PRINT_CHAR
0305 43                    524                     INC BX
0306 E2F4                  525             LOOP S_BUFF
                           526             
0308                       527     SEND_INPUT_END:
0308 5A                    528     POP DX
0309 59                    529     POP CX
030A 5B                    530     POP BX
030B 58                    531     POP AX
030C CB                    532     RET
                           533     SEND_INPUT ENDP
                           534     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
030D                       535     SERIAL_REC_ACTION       PROC    FAR
030D 51                    536                     PUSH    CX
030E 53                    537                     PUSH    BX
030F 1E                    538                     PUSH    DS
                           539                     
0310 BB----         R      540                     MOV     BX,DATA_SEG             ;initialize data segment register
0313 8EDB                  541                     MOV     DS,BX
                           542                     
0315 803E860001            543                     CMP DS:REPLY_FLAG, 1
031A 7547                  544                     JNE next_id
031C 3C2F                  545                     CMP AL, '/'
031E 741B                  546                     JE reply
                           547                     
0320 803E870000            548                     CMP DS:SEND_FLAG, 0
0325 7439                  549                     JE id_skip2
                           550                     
0327 833E610000            551                     CMP DS:KEYPAD_INDEX, 0
032C 7432                  552                     JE id_skip2
                           553                     
032E 9AF102----     R      554                     CALL FAR PTR SEND_INPUT
0333 C606870000            555                     MOV DS:SEND_FLAG, 0
                           556                     
0338 EB2690                557                     JMP id_skip2
                           558                     
033B                       559             reply:
033B 33DB                  560                     XOR BX,BX
033D                       561             start_send:
033D 33C0                  562                     XOR AX,AX
033F 8A477D                563                     MOV AL, DS:REPLY_MESSAGE[BX]
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   12


LOC  OBJ                  LINE     SOURCE

0342 9A0000----     E      564                     CALL FAR PTR PRINT_CHAR
0347 43                    565                     INC BX
0348 3A1E8400              566                     CMP BL, DS:REPLY_COUNT
034C 75EF                  567                     JNE start_send
                           568                     
034E C606860000            569                     MOV DS:REPLY_FLAG, 0
0353 C6067C0000            570                     MOV DS:ID_FLAG_r, 0
0358 C6067B0000            571                     MOV DS:ID_FLAG_@, 0
035D E99B00                572                     JMP S_RET
                           573             
0360                       574             id_skip2:
0360 EB5E90                575                     JMP id_skip
                           576                     
0363                       577             next_id:
                           578                     
0363 803E7C0001            579                     CMP DS:ID_FLAG_r, 1
0368 7512                  580                     JNE id_flag_label
036A 38067A00              581                     CMP DS:MY_ID[1], AL
036E 7529                  582                     JNE id_not_equal
                           583                     ;start writing to pc
0370 FE068600              584                     INC DS:REPLY_FLAG
0374 C6067C0000            585                     MOV DS:ID_FLAG_r, 0
0379 EB4590                586                     JMP id_skip
                           587                     
037C                       588             id_flag_label:
                           589             
037C 803E7B0001            590                     CMP DS:ID_FLAG_@, 1
0381 752F                  591                     JNE protocol_rec
0383 3C72                  592                     CMP AL,'r'
0385 750A                  593                     JNE id_not_r
0387 BA0100                594                     MOV DX, 1
038A 88167C00              595                     MOV DS:ID_FLAG_r,DL
038E EB6B90                596                     JMP S_RET
0391                       597             id_not_r:
0391 C6067B0000            598                     MOV DS:ID_FLAG_@, 0
0396 EB2890                599                     JMP id_skip
                           600             
0399                       601             id_not_equal:
0399 C6067C0000            602                     MOV DS:ID_FLAG_r, 0
039E 33DB                  603                     XOR BX,BX
03A0                       604             start_send1:
03A0 33C0                  605                     XOR AX,AX
03A2 8A878100              606                     MOV AL, DS:FAIL_MESSAGE[BX]
03A6 9A0000----     E      607                     CALL FAR PTR PRINT_CHAR
03AB 43                    608                     INC BX
03AC 3A1E8500              609                     CMP BL, DS:FAIL_COUNT
03B0 75EE                  610                     JNE start_send1
                           611                     
03B2                       612             protocol_rec:
03B2 3C40                  613                     CMP AL,'@'
03B4 750A                  614                     JNE id_skip
03B6 BA0100                615                     MOV DX, 1
03B9 88167B00              616                     MOV DS:ID_FLAG_@,DL
03BD EB3C90                617                     JMP S_RET
                           618                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   13


LOC  OBJ                  LINE     SOURCE

03C0                       619             id_skip:
                           620             
03C0 3C7E                  621                     CMP AL, '~'
03C2 7503                  622                     JNE resume
                           623                     
                           624                     ;CALL FAR PTR CLEAR_LCD
03C4 EB3590                625                     JMP S_RET
                           626                     
03C7                       627                     resume:
                           628                     ;CALL FAR PTR UPDATE_LCD_INPUT
                           629                     
03C7                       630                     continue3:
                           631                     
03C7 3C3C                  632                     CMP     AL,'<'
03C9 750B                  633                     JNE     S_FAST
                           634     
03CB FE061700              635                     INC     DS:T_COUNT_SET
03CF FE061700              636                     INC     DS:T_COUNT_SET
                           637     
03D3 EB0D90                638                     JMP     S_NEXT0
03D6                       639     S_FAST:
03D6 3C3E                  640                     CMP     AL,'>'
03D8 7521                  641                     JNE     S_RET
                           642     
03DA FE0E1700              643                     DEC     DS:T_COUNT_SET
03DE FE0E1700              644                     DEC     DS:T_COUNT_SET
                           645     
03E2                       646     S_NEXT0:
03E2 B91600                647                     MOV     CX,22                   ;initialize counter for message
03E5 BB0000                648                     MOV     BX,0
                           649     
03E8 8A4718                650     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
03EB 9A0000----     E      651                     call    FAR ptr print_char
03F0 43                    652                     INC     BX
03F1 E2F5                  653                     LOOP    S_NEXT1
                           654     
03F3 A01700                655                     MOV     AL,DS:T_COUNT_SET       ;print current period of timer0
03F6 9A0000----     E      656                     CALL    FAR PTR PRINT_2HEX
03FB                       657     S_RET:
03FB 1F                    658                     POP     DS
03FC 5B                    659                     POP     BX
03FD 59                    660                     POP     CX
03FE CB                    661                     RET
                           662     SERIAL_REC_ACTION       ENDP
                           663     
03FF                       664     TIMER2_ACTION   PROC    FAR
03FF 50                    665                     PUSH    AX
0400 1E                    666                     PUSH    DS
0401 53                    667                     PUSH    BX
0402 51                    668                     PUSH    CX
0403 52                    669                     PUSH    DX
                           670                     
                           671                     
0404 B8----         R      672                     MOV     AX,DATA_SEG
0407 8ED8                  673                     MOV     DS,AX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   14


LOC  OBJ                  LINE     SOURCE

                           674             
0409 FE0E1600              675                     DEC     DS:T_COUNT
040D 7538                  676                     JNZ     T_NEXT1
040F A01700                677                     MOV     AL,DS:T_COUNT_SET
0412 A21600                678                     MOV     DS:T_COUNT,AL
                           679     
0415                       680     T_NEXT0:
0415 A05F00                681                     MOV AL, DS:ENABLE_BYTE
0418 BA8001                682                     MOV DX, 180H
041B EE                    683                     OUT DX, AL
                           684                     
041C 33DB                  685                     XOR BX, BX
041E 8A1E6000              686                     MOV BL, DS:BCD_INDEX
0422 8A4759                687                     MOV AL, DS:BCD_MESSAGE[BX]
                           688             
0425 9AB804----     R      689                     CALL FAR PTR BCD_TO_7SEG
                           690     
042A BA0002                691                     MOV DX, 200H
042D EE                    692                     OUT DX, AL
                           693     
042E FE066000              694                     INC DS:BCD_INDEX
0432 D0065F00              695                     ROL DS:ENABLE_BYTE, 1
0436 803E5F00BF            696                     CMP DS:ENABLE_BYTE, 10111111b
043B 750A                  697                     JNE T_NEXT1
043D C6065F00FE            698                     MOV DS:ENABLE_BYTE, 11111110b 
0442 C606600000            699                     MOV DS:BCD_INDEX, 0
                           700     
                           701                     
0447                       702     T_NEXT1:
0447 803E700000            703                     CMP DS:DAC_LEN, 0
044C 743C                  704                     JE ISR_END
                           705                     
                           706                     
044E 8B367100              707                     MOV SI, DS:SI_PTR
                           708                             
0452 BB0000                709                     MOV BX, 0
0455 33C0                  710                     XOR AX, AX
0457 8A4766                711                     MOV AL, DS:DAC_ADDR[BX]
                           712                     
045A BB0001                713                     MOV BX, 100H
045D F7E3                  714                     MUL BX
                           715                     
045F 8B166400              716                     MOV DX, DS:DAC_BASE
0463 03D0                  717                     ADD DX, AX
                           718                     
0465 1E                    719                     PUSH DS
0466 8EDA                  720                     MOV DS, DX
                           721                     
0468 8B04                  722                     MOV AX, [SI]
                           723                     
046A BA1001                724                     MOV DX, 110H
046D EE                    725                     OUT DX, AL
                           726                     
046E 1F                    727                     POP DS
                           728                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   15


LOC  OBJ                  LINE     SOURCE

046F FF067100              729                     INC DS:SI_PTR
0473 813E71000010          730                     CMP DS:SI_PTR, 1000H
0479 750F                  731                     JNE ISR_END
                           732                     
047B C70671000000          733                     MOV DS:SI_PTR, 0
0481 FE0E7000              734                     DEC DS:DAC_LEN
0485 9A9004----     R      735                     CALL FAR PTR DAC_SHIFT
                           736                     
048A                       737     ISR_END:
                           738                     
048A 5A                    739                     POP DX
048B 59                    740                     POP     CX
048C 5B                    741                     POP     BX
048D 1F                    742                     POP     DS
048E 58                    743                     POP AX
048F CB                    744                     RET
                           745     TIMER2_ACTION   ENDP
                           746     
                           747     
0490                       748     DAC_SHIFT PROC FAR
0490 50                    749             PUSH AX
0491 53                    750             PUSH BX
0492 51                    751             PUSH CX
0493 52                    752             PUSH DX
                           753     
0494 33C9                  754             XOR CX, CX
0496 8A0E7000              755             MOV CL, DS:DAC_LEN
049A 80F900                756             CMP CL, 0
049D 7414                  757             JE END_SHIFT
                           758     
049F                       759             SHIFT_LOOP:
                           760     
049F 33DB                  761             XOR BX, BX
04A1 8A1E7000              762             MOV BL, DS:DAC_LEN
04A5 2BD9                  763             SUB BX, CX
04A7 43                    764             INC BX
                           765             
04A8 33D2                  766             XOR DX, DX
04AA 8A5766                767             MOV DL, DS:DAC_ADDR[BX]
04AD 4B                    768             DEC BX
04AE 885766                769             MOV DS:DAC_ADDR[BX], DL
                           770     
04B1 E2EC                  771             LOOP SHIFT_LOOP
                           772             
04B3                       773             END_SHIFT:
04B3 5A                    774             POP DX
04B4 59                    775             POP CX
04B5 5B                    776             POP BX
04B6 58                    777             POP AX
04B7 CB                    778             RET
                           779     DAC_SHIFT ENDP
                           780     
04B8                       781     BCD_TO_7SEG PROC FAR
                           782     
04B8 53                    783             PUSH BX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   16


LOC  OBJ                  LINE     SOURCE

04B9 51                    784             PUSH CX
04BA 52                    785             PUSH DX
                           786     
04BB 3C00                  787             CMP AL, 0
04BD 7505                  788             JNE one
04BF B03F                  789             MOV AL, 00111111b;
04C1 EB5B90                790             JMP endfunc
                           791             
04C4                       792             one:
04C4 3C01                  793             CMP AL, 1
04C6 7505                  794             JNE two
04C8 B006                  795             MOV AL, 00000110b;
04CA EB5290                796             JMP endfunc
                           797             
04CD                       798             two:
04CD 3C02                  799             CMP AL,2
04CF 7505                  800             JNE three
04D1 B05B                  801             MOV AL, 01011011b;
04D3 EB4990                802             JMP endfunc
                           803             
04D6                       804             three:
04D6 3C03                  805             CMP AL,3
04D8 7505                  806             JNE four
04DA B04F                  807             MOV AL, 01001111b;
04DC EB4090                808             JMP endfunc
                           809             
04DF                       810             four:
04DF 3C04                  811             CMP AL,4
04E1 7505                  812             JNE five
04E3 B066                  813             MOV AL, 01100110b;
04E5 EB3790                814             JMP endfunc
                           815             
04E8                       816             five:
04E8 3C05                  817             CMP AL,5
04EA 7505                  818             JNE six
04EC B06D                  819             MOV AL, 01101101b;
04EE EB2E90                820             JMP endfunc
                           821             
04F1                       822             six:
04F1 3C06                  823             CMP AL,6
04F3 7505                  824             JNE seven
04F5 B07D                  825             MOV AL, 01111101b;
04F7 EB2590                826             JMP endfunc
                           827             
04FA                       828             seven:
04FA 3C07                  829             CMP AL,7
04FC 7505                  830             JNE eight
04FE B007                  831             MOV AL, 00000111b;
0500 EB1C90                832             JMP endfunc
                           833             
0503                       834             eight:
0503 3C08                  835             CMP AL,8
0505 7505                  836             JNE nine
0507 B07F                  837             MOV AL, 01111111b;
0509 EB1390                838             JMP endfunc
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:12:23  11/15/;3  PAGE   17


LOC  OBJ                  LINE     SOURCE

                           839             
050C                       840             nine:
050C 3C09                  841             CMP AL,9
050E 7505                  842             JNE hifn
0510 B06F                  843             MOV AL, 01101111b;
0512 EB0A90                844             JMP endfunc
                           845             
0515                       846             hifn:
0515 3C2D                  847             CMP AL,'-'
0517 7505                  848             JNE endfunc
0519 B040                  849             MOV AL, 01000000b;
051B EB0190                850             JMP endfunc
                           851             
051E                       852             endfunc:
051E 5A                    853             POP DX
051F 59                    854             POP CX
0520 5B                    855             POP BX
                           856     
0521 CB                    857     RET
                           858     BCD_TO_7SEG ENDP
                           859     
----                       860     CODE_SEG        ENDS
                           861     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
