8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  D:\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   set_timer2:far
                            20     
                            21     ;IO Setup for 80C188 
  FFA0                      22             UMCR    EQU    0FFA0H ; Upper Memory Control Register
  FFA2                      23             LMCR    EQU    0FFA2H ; Lower Memory control Register         
  FFA4                      24             PCSBA   EQU    0FFA4H ; Peripheral Chip Select Base Address
  FFA8                      25             MPCS    EQU    0FFA8H ; MMCS and PCS Alter Control Register
  0080                      26             A_8255  EQU    0080H
  0081                      27             B_8255  EQU    0081H
  0082                      28             C_8255  EQU    0082H
  0083                      29             CWR_8255  EQU    0083H
  FF38                      30             INT0CON  EQU   0FF38H
  FF22                      31             EOI EQU 0FF22H
  FF28                      32             IMASK EQU 0FF28H
                            33     
----                        34     STACK_SEG       SEGMENT
0000 (256                   35                     DB      256 DUP(?)
     ??
     )
0100                        36             TOS     LABEL   WORD
----                        37     STACK_SEG       ENDS
                            38     
                            39     
----                        40     DATA_SEG        SEGMENT
0000 0A                     41             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
     505420202020
0016 2F                     42             T_COUNT         DB      2FH
0017 2F                     43             T_COUNT_SET     DB      2FH
0018 0A                     44             REC_MESS        DB      10,13,'Period of timer0 =     '
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    2


LOC  OBJ                  LINE     SOURCE

0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D202020
     2020
----                        45     DATA_SEG        ENDS
                            46     
                            47     
----                        48     CODE_SEG        SEGMENT
                            49     
                            50             PUBLIC          START
                            51     
                            52     ASSUME  CS:CODE_SEG, SS:STACK_SEG
                            53     
0000                        54     START:
                            55     ;initialize stack area
0000 B8----         R       56                     MOV     AX,STACK_SEG            
0003 8ED0                   57                     MOV     SS,AX
0005 368B260001             58                     MOV     SP,TOS
                            59     
                            60     ; Initialize the on-chip pheripherals
000A 9A0000----     E       61                     CALL    FAR PTR IODEFINE
                            62                     
                            63     
                            64     
                            65     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                            66        
                            67     ; Initialize MPCS to MAP peripheral to IO address
                            68             
000F BAA8FF                 69             MOV DX, MPCS
0012 B88300                 70             MOV AX, 0083H
0015 EF                     71             OUT DX, AX
                            72     
                            73     ; PCSBA initial, set the parallel port start from 00H
0016 BAA4FF                 74             MOV DX, PCSBA
0019 B80300                 75             MOV AX, 0003H ; Peripheral starting address 00H no READY, No Waits
001C EF                     76             OUT DX, AX
                            77     
                            78     ; Initialize LMCS 
001D BAA2FF                 79         MOV DX, LMCR
0020 B8C401                 80         MOV AX, 01C4H  ; Starting address 1FFFH, 8K, No waits, last shoud be 5H for 1 wai
                                   ts      
0023 EF                     81         OUT DX, AX
                            82     
0024 B8----         R       83             MOV AX, DATA_SEG
0027 8ED8                   84             MOV DS, AX
                            85                              
0029 BA8300                 86             MOV DX, CWR_8255
002C B88000                 87             MOV AX, 0080h
002F EF                     88             OUT DX, AX
                            89             
0030 BA8000                 90             MOV DX, A_8255
0033 B023                   91             MOV AL, 23h
0035 F6D0                   92             NOT AL
0037 EE                     93             OUT DX, AL
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    3


LOC  OBJ                  LINE     SOURCE

                            94     
                            95     ; LCD Initialization ;
                            96     
                            97     ;Function set 1;
                            98     ; 60 ms delay ;
0038 B975AA                 99             MOV CX, 0AA75h ; 43637 dec
003B                       100             loop60ms:       
003B 90                    101                     NOP        ; 3 clocks
003C 49                    102                     DEC CX     ; 3 clocks
003D 75FC                  103             JNZ loop60ms ; 16 clocks
                           104             
003F 33C0                  105             XOR AX, AX
0041 B020                  106             MOV AL, 00100000b
0043 BA8100                107             MOV DX, B_8255
0046 EE                    108             OUT DX, AL
                           109             
0047 33C0                  110             XOR AX, AX
0049 B03C                  111             MOV AL, 00111100b
004B BA8200                112             MOV DX, C_8255
004E EE                    113             OUT DX, AL
                           114             
004F 33C0                  115             XOR AX, AX
0051 B000                  116             MOV AL, 00000000b
0053 BA8100                117             MOV DX, B_8255
0056 EE                    118             OUT DX, AL
                           119             
                           120     
                           121     ;Function set 2;
                           122     ; 5 ms delay;
0057 B9350E                123             MOV CX, 0E35h ; 3637 dec
005A                       124             loop5ms:        
005A 90                    125                     NOP        ; 3 clocks
005B 49                    126                     DEC CX     ; 3 clocks
005C 75FC                  127             JNZ loop5ms ; 16 clocks
                           128             
005E 33C0                  129             XOR AX, AX
0060 B020                  130             MOV AL, 00100000b
0062 BA8100                131             MOV DX, B_8255
0065 EE                    132             OUT DX, AL
                           133             
0066 33C0                  134             XOR AX, AX
0068 B03C                  135             MOV AL, 00111100b
006A BA8200                136             MOV DX, C_8255
006D EE                    137             OUT DX, AL
                           138             
006E 33C0                  139             XOR AX, AX
0070 B000                  140             MOV AL, 00000000b
0072 BA8100                141             MOV DX, B_8255
0075 EE                    142             OUT DX, AL
                           143             
                           144             
                           145     ;Function set 3;
                           146     ; 100 us delay;
0076 B94900                147             MOV CX, 0049h ; 73 dec
0079                       148             loop4point100us:        
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    4


LOC  OBJ                  LINE     SOURCE

0079 90                    149                     NOP        ; 3 clocks
007A 49                    150                     DEC CX     ; 3 clocks
007B 75FC                  151             JNZ loop4point100us ; 16 clocks
                           152             
007D 33C0                  153             XOR AX, AX
007F B020                  154             MOV AL, 00100000b
0081 BA8100                155             MOV DX, B_8255
0084 EE                    156             OUT DX, AL
                           157             
0085 33C0                  158             XOR AX, AX
0087 B03C                  159             MOV AL, 00111100b
0089 BA8200                160             MOV DX, C_8255
008C EE                    161             OUT DX, AL
                           162             
008D 33C0                  163             XOR AX, AX
008F B000                  164             MOV AL, 00000000b
0091 BA8100                165             MOV DX, B_8255
0094 EE                    166             OUT DX, AL
                           167             
                           168             ; ;Display Off;
                           169             
                           170             ; XOR AX, AX
                           171             ; MOV AL, 00100000b
                           172             ; MOV DX, B_8255
                           173             ; OUT DX, AL
                           174             
                           175             ; XOR AX, AX
                           176             ; MOV AL, 00001000b
                           177             ; MOV DX, C_8255
                           178             ; OUT DX, AL
                           179             
                           180             ; XOR AX, AX
                           181             ; MOV AL, 00000000b
                           182             ; MOV DX, B_8255
                           183             ; OUT DX, AL
                           184             
                           185     ; 40 us delay;
0095 B91E00                186             MOV CX, 001Eh ; 30 dec
0098                       187             loop40us:       
0098 90                    188                     NOP        ; 3 clocks
0099 49                    189                     DEC CX     ; 3 clocks
009A 75FC                  190             JNZ loop40us ; 16 clocks
                           191             
                           192             ;Display Clear;
                           193             
009C 33C0                  194             XOR AX, AX
009E B020                  195             MOV AL, 00100000b
00A0 BA8100                196             MOV DX, B_8255
00A3 EE                    197             OUT DX, AL
                           198             
00A4 33C0                  199             XOR AX, AX
00A6 B001                  200             MOV AL, 00000001b
00A8 BA8200                201             MOV DX, C_8255
00AB EE                    202             OUT DX, AL
                           203             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    5


LOC  OBJ                  LINE     SOURCE

00AC 33C0                  204             XOR AX, AX
00AE B000                  205             MOV AL, 00000000b
00B0 BA8100                206             MOV DX, B_8255
00B3 EE                    207             OUT DX, AL
                           208             
                           209             ; 1.6ms delay;
00B4 B98C04                210             MOV CX, 048Ch ; 30 dec
00B7                       211             loop1point6ms:  
00B7 90                    212                     NOP        ; 3 clocks
00B8 49                    213                     DEC CX     ; 3 clocks
00B9 75FC                  214             JNZ loop1point6ms ; 16 clocks
                           215             
                           216             
                           217             ;Entry Mode Set;
                           218             
00BB 33C0                  219             XOR AX, AX
00BD B020                  220             MOV AL, 00100000b
00BF BA8100                221             MOV DX, B_8255
00C2 EE                    222             OUT DX, AL
                           223             
00C3 33C0                  224             XOR AX, AX
00C5 B006                  225             MOV AL, 00000110b
00C7 BA8200                226             MOV DX, C_8255
00CA EE                    227             OUT DX, AL
                           228             
00CB 33C0                  229             XOR AX, AX
00CD B000                  230             MOV AL, 00000000b
00CF BA8100                231             MOV DX, B_8255
00D2 EE                    232             OUT DX, AL
                           233             
                           234             ; 40 us delay;
00D3 B91E00                235             MOV CX, 001Eh ; 30 dec
00D6                       236             loop40us2:      
00D6 90                    237                     NOP        ; 3 clocks
00D7 49                    238                     DEC CX     ; 3 clocks
00D8 75FC                  239             JNZ loop40us2 ; 16 clocks
                           240             
                           241             
                           242             ;Setting Addres of DDRAM;
                           243             
00DA 33C0                  244             XOR AX, AX
00DC B020                  245             MOV AL, 00100000b
00DE BA8100                246             MOV DX, B_8255
00E1 EE                    247             OUT DX, AL
                           248             
00E2 33C0                  249             XOR AX, AX
00E4 B080                  250             MOV AL, 10000000b
00E6 BA8200                251             MOV DX, C_8255
00E9 EE                    252             OUT DX, AL
                           253             
00EA 33C0                  254             XOR AX, AX
00EC B000                  255             MOV AL, 00000000b
00EE BA8100                256             MOV DX, B_8255
00F1 EE                    257             OUT DX, AL
                           258             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           259             ; 40 us delay;
00F2 B91E00                260             MOV CX, 001Eh ; 30 dec
00F5                       261             loop40us3:      
00F5 90                    262                     NOP        ; 3 clocks
00F6 49                    263                     DEC CX     ; 3 clocks
00F7 75FC                  264             JNZ loop40us3 ; 16 clocks
                           265             
                           266             
                           267             ;Display On;
                           268             
00F9 33C0                  269             XOR AX, AX
00FB B020                  270             MOV AL, 00100000b
00FD BA8100                271             MOV DX, B_8255
0100 EE                    272             OUT DX, AL
                           273             
0101 33C0                  274             XOR AX, AX
0103 B00C                  275             MOV AL, 00001100b
0105 BA8200                276             MOV DX, C_8255
0108 EE                    277             OUT DX, AL
                           278             
0109 33C0                  279             XOR AX, AX
010B B000                  280             MOV AL, 00000000b
010D BA8100                281             MOV DX, B_8255
0110 EE                    282             OUT DX, AL
                           283             
                           284             ; 40 us delay;
0111 B91E00                285             MOV CX, 001Eh ; 30 dec
0114                       286             loop40us4:      
0114 90                    287                     NOP        ; 3 clocks
0115 49                    288                     DEC CX     ; 3 clocks
0116 75FC                  289             JNZ loop40us4 ; 16 clocks
                           290             
                           291             
                           292             ;Letter Begin;
                           293             
                           294             ;Writing Data to DDRAM;
0118 33C0                  295             XOR AX, AX
011A B0A0                  296             MOV AL, 10100000b
011C BA8100                297             MOV DX, B_8255
011F EE                    298             OUT DX, AL
                           299             
0120 33C0                  300             XOR AX, AX
0122 B048                  301             MOV AL, 01001000b
0124 BA8200                302             MOV DX, C_8255
0127 EE                    303             OUT DX, AL
                           304             
0128 33C0                  305             XOR AX, AX
012A B080                  306             MOV AL, 10000000b
012C BA8100                307             MOV DX, B_8255
012F EE                    308             OUT DX, AL
                           309             
                           310             ;Letter End;    
                           311             
                           312             
0130 EBFE                  313     NEXT:     JMP NEXT
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    7


LOC  OBJ                  LINE     SOURCE

                           314     
                           315     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
0132                       316     SERIAL_REC_ACTION       PROC    FAR
0132 51                    317                     PUSH    CX
0133 53                    318                     PUSH    BX
0134 1E                    319                     PUSH    DS
                           320     
0135 BB----         R      321                     MOV     BX,DATA_SEG             ;initialize data segment register
0138 8EDB                  322                     MOV     DS,BX
                           323     
013A 3C3C                  324                     CMP     AL,'<'
013C 750B                  325                     JNE     S_FAST
                           326     
013E FE061700              327                     INC     DS:T_COUNT_SET
0142 FE061700              328                     INC     DS:T_COUNT_SET
                           329     
0146 EB0D90                330                     JMP     S_NEXT0
0149                       331     S_FAST:
0149 3C3E                  332                     CMP     AL,'>'
014B 7521                  333                     JNE     S_RET
                           334     
014D FE0E1700              335                     DEC     DS:T_COUNT_SET
0151 FE0E1700              336                     DEC     DS:T_COUNT_SET
                           337     
0155                       338     S_NEXT0:
0155 B91600                339                     MOV     CX,22                   ;initialize counter for message
0158 BB0000                340                     MOV     BX,0
                           341     
015B 8A4718                342     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
015E 9A0000----     E      343                     call    FAR ptr print_char
0163 43                    344                     INC     BX
0164 E2F5                  345                     LOOP    S_NEXT1
                           346     
0166 A01700                347                     MOV     AL,DS:T_COUNT_SET       ;print current period of timer0
0169 9A0000----     E      348                     CALL    FAR PTR PRINT_2HEX
016E                       349     S_RET:
016E 1F                    350                     POP     DS
016F 5B                    351                     POP     BX
0170 59                    352                     POP     CX
0171 CB                    353                     RET
                           354     SERIAL_REC_ACTION       ENDP
                           355     
                           356     
                           357     
0172                       358     TIMER2_ACTION   PROC    FAR
0172 50                    359                     PUSH    AX
0173 1E                    360                     PUSH    DS
0174 53                    361                     PUSH    BX
0175 51                    362                     PUSH    CX
                           363     
0176 B8----         R      364                     MOV     AX,DATA_SEG
0179 8ED8                  365                     MOV     DS,AX
                           366             
017B FE0E1600              367                     DEC     DS:T_COUNT
017F 7516                  368                     JNZ     T_NEXT1
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    10:43:50  10/04/;3  PAGE    8


LOC  OBJ                  LINE     SOURCE

0181 A01700                369                     MOV     AL,DS:T_COUNT_SET
0184 A21600                370                     MOV     DS:T_COUNT,AL
                           371     
0187 B91400                372                     MOV     CX,20
018A BB0000                373                     MOV     BX,0H
018D                       374     T_NEXT0:
018D 8A07                  375                     MOV     AL,DS:TIMER0_MESS[BX]
018F 43                    376                     INC     BX
0190 9A0000----     E      377                     CALL    FAR PTR PRINT_CHAR
0195 E2F6                  378                     LOOP    T_NEXT0
                           379     
0197                       380     T_NEXT1:        
0197 59                    381                     POP     CX
0198 5B                    382                     POP     BX
0199 1F                    383                     POP     DS
019A 58                    384                     POP     AX
019B CB                    385                     RET
                           386     TIMER2_ACTION   ENDP
                           387     
                           388     
----                       389     CODE_SEG        ENDS
                           390     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
