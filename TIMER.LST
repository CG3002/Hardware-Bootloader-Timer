8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  D:\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   LCD_INIT:far, MESSAGE_LCD:far, CLEAR_LCD:far, UPDATE_LCD_INPUT:far
                            20     extrn   set_timer2:far
                            21     
                            22     ;IO Setup for 80C188 
  FFA0                      23             UMCR    EQU    0FFA0H ; Upper Memory Control Register
  FFA2                      24             LMCR    EQU    0FFA2H ; Lower Memory control Register         
  FFA4                      25             PCSBA   EQU    0FFA4H ; Peripheral Chip Select Base Address
  FFA8                      26             MPCS    EQU    0FFA8H ; MMCS and PCS Alter Control Register
  0080                      27             A_8255  EQU    0080H
  0081                      28             B_8255  EQU    0081H
  0082                      29             C_8255  EQU    0082H
  0083                      30             CWR_8255  EQU    0083H
  FF38                      31             INT0CON  EQU   0FF38H
  FF22                      32             EOI EQU 0FF22H
  FF28                      33             IMASK EQU 0FF28H
  FFA6                      34             MMCS    EQU    0FFA6H 
  4000                      35             DAC EQU 4000H
                            36     
                            37     
----                        38     STACK_SEG       SEGMENT
0000 (512                   39                     DB      512 DUP(?)
     ??
     )
0200                        40             TOS     LABEL   WORD
----                        41     STACK_SEG       ENDS
                            42     
                            43     
----                        44     DATA_SEG        SEGMENT
0000 0A                     45             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    2


LOC  OBJ                  LINE     SOURCE

     505420202020
0016 18                     46             T_COUNT         DB      24
0017 18                     47             T_COUNT_SET     DB      24
0018 0A                     48             REC_MESS        DB      10,13,'Period of timer0 =     '
0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D202020
     2020
0031 (32                    49             MESSAGE     DB  32 dup('h')
     68
     )
0051 00                     50             KEYPAD_INPUT DB  0,0,0,0,0,0,0,0
0052 00
0053 00
0054 00
0055 00
0056 00
0057 00
0058 00
0059 2D                     51             BCD_MESSAGE DB  '-','-','-','-','-','-'
005A 2D
005B 2D
005C 2D
005D 2D
005E 2D
005F FE                     52             ENABLE_BYTE DB  11111110b
0060 00                     53             BCD_INDEX   DB  0
0061 0000                   54             KEYPAD_INDEX DW 0
0063 20                     55             M_SIZE          DB  32
0064 0040                   56             DAC_BASE    DW  4000H
0066 00                     57             DAC_ADDR    DB  0, 0, 0, 0, 0, 0, 0, 0, 0, 0 
0067 00
0068 00
0069 00
006A 00
006B 00
006C 00
006D 00
006E 00
006F 00
0070 00                     58             DAC_LEN     DB  0
0071 0000                   59             SI_PTR      DW  0
0073 ??                     60             CHAR            DB  ?
0074 ??                     61             REG_AL          DB  ?
0075 ??                     62             REG_BH          DB  ?
0076 ??                     63             REG_CL          DB  ?
0077 00                     64             FLAG        DB  0
0078 00                     65             LONG_PRESS_FLAG DB 0
0079 7231                   66             MY_ID           DB      'r1'
007B 00                     67             ID_FLAG_@               DB      0
007C 00                     68             ID_FLAG_r               DB      0
007D 4072312F               69             REPLY_MESSAGE   DB      '@r1/'
0081 40302F                 70             FAIL_MESSAGE DB '@0/'
0084 04                     71             REPLY_COUNT     DB      4
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    3


LOC  OBJ                  LINE     SOURCE

0085 03                     72             FAIL_COUNT      DB      3
0086 00                     73             REPLY_FLAG      DB      0
0087 00                     74             SEND_FLAG   DB  0
0088 (13                    75             SEND_BUFFER DB  13 dup(0)
     00
     )
0095 0000                   76             SEND_BUFFER_LEN DW 0
0097 0000                   77             MAX_INPUT_SIZE DW 0
0099 0000                   78             QTY_FLAG DW 0
----                        79     DATA_SEG        ENDS
                            80     
                            81     
----                        82     CODE_SEG        SEGMENT
                            83     
                            84             PUBLIC          START
                            85     
                            86     ASSUME  CS:CODE_SEG, SS:STACK_SEG
                            87     
0000                        88     START:
                            89     ;initialize stack area
0000 B8----         R       90                     MOV     AX,STACK_SEG            
0003 8ED0                   91                     MOV     SS,AX
0005 368B260002             92                     MOV     SP,TOS
                            93                     
                            94     ; Initialize the on-chip pheripherals
000A 9A0000----     E       95                     CALL    FAR PTR IODEFINE
                            96                     
000F 9A0000----     E       97     call set_timer2
0014 FB                     98                    STI
                            99     
                           100     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                           101     
                           102     ;Initialize MMCS
                           103             
0015 BAA6FF                104             MOV DX, MMCS
0018 B80340                105             MOV AX, 4003H
001B EF                    106             OUT DX, AX
                           107     
                           108     ; Initialize MPCS to MAP peripheral to IO address
                           109             
001C BAA8FF                110             MOV DX, MPCS
001F B88320                111             MOV AX, 2083H
0022 EF                    112             OUT DX, AX
                           113        
                           114     ; PCSBA initial, set the parallel port start from 00H
0023 BAA4FF                115             MOV DX, PCSBA
0026 B80300                116             MOV AX, 0003H ; Peripheral starting address 00H no READY, No Waits
0029 EF                    117             OUT DX, AX
                           118     
                           119     ; Initialize LMCS 
002A BAA2FF                120         MOV DX, LMCR
002D B8C401                121         MOV AX, 01C4H  ; Starting address 1FFFH, 8K, No waits, last shoud be 5H for 1 wai
                                   ts      
0030 EF                    122         OUT DX, AX
                           123             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    4


LOC  OBJ                  LINE     SOURCE

0031 B8----         R      124             MOV AX, DATA_SEG
0034 8ED8                  125             MOV DS, AX
                           126                              
0036 BA8300                127             MOV DX, CWR_8255
0039 B88200                128             MOV AX, 0082h
003C EF                    129             OUT DX, AX
                           130             
003D                       131     NEXT:
003D 9A4400----     R      132             CALL FAR PTR KEYPAD_LOOP
                           133             
0042 EBF9                  134     JMP NEXT
                           135     
0044                       136     KEYPAD_LOOP PROC FAR
0044 50                    137     PUSH AX
0045 53                    138     PUSH BX
0046 51                    139     PUSH CX
0047 52                    140     PUSH DX
                           141             
0048 9AEF02----     R      142                             CALL FAR PTR DEBOUNCE           
                           143                             
004D C606740003            144     WAIT_1:         MOV DS:REG_AL, 03H
0052 BB0000                145                         MOV BX, 0000H
0055 BA8200                146                         MOV DX,C_8255
0058 8AC3                  147                         MOV AL,BL
005A EE                    148                         OUT DX,AL
                           149                        
005B BA8100                150                         MOV DX,B_8255
005E EC                    151                         IN AL,DX
005F 8AD8                  152                         MOV BL,AL  
0061 80E3FC                153                         AND BL,0FCH
0064 80FBFC                154                         CMP BL,0FCH
                           155                      
0067 7449                  156                     JE LONG_PRESS
                           157                             
0069 B3FE                  158                         MOV BL, 0FEH
006B C606750004            159                         MOV DS:REG_BH, 04H
                           160                        
0070                       161     NXTROW: 
0070 C0C307                162                     ROL BL,07H
0073 8AEB                  163                             MOV CH,BL
0075 BA8200                164                             MOV DX,C_8255
0078 8AC3                  165                             MOV AL,BL
007A EE                    166                             OUT DX,AL
                           167                             
007B BA8100                168                             MOV DX,B_8255
007E EC                    169                             IN AL,DX
007F 8AD8                  170                             MOV BL,AL
0081 80E3FC                171                             AND BL,0FCH
0084 C606760006            172                             MOV DS:REG_CL,06H
0089 C0DB02                173                             RCR BL,02H
008C D0DB                  174     NXTCOL:         RCR BL,01H
008E 732A                  175                             JNC CODEKY
0090 FE0E7400              176                             DEC DS:REG_AL
0094 FE0E7600              177                             DEC DS:REG_CL
0098 803E760003            178                             CMP DS:REG_CL,03H
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    5


LOC  OBJ                  LINE     SOURCE

009D 745F                  179                             JE KEYPAD3
                           180                             
009F 803E760000            181                             CMP DS:REG_CL, 0H
00A4 7455                  182                             JE SUBTRACT2
00A6 EBE4                  183                             JMP NXTCOL
                           184                             
00A8 8ADD                  185                             MOV BL,CH
00AA FE0E7500              186                             DEC DS:REG_BH
00AE 75C0                  187                             JNZ NXTROW
00B0 EB9B                  188                             JMP WAIT_1
                           189                             
00B2                       190     LONG_PRESS:
00B2 C606780000            191                             MOV DS:LONG_PRESS_FLAG, 0
00B7 EB4890                192                             JMP RETURN2
00BA                       193     CODEKY:
00BA 803E74000B            194                         CMP DS:REG_AL, 11
00BF 7505                  195                             JNE bcd_upd
00C1 C606740000            196                             MOV DS:REG_AL, 0
                           197                             
00C6                       198     bcd_upd:
00C6 803E780000            199                             CMP DS:LONG_PRESS_FLAG, 0
00CB 7534                  200                             JNE RETURN2
                           201                             
00CD 803E74000A            202                             CMP DS:REG_AL, 10
00D2 7508                  203                             JNE BACKSPACE
00D4 9A5602----     R      204                             CALL FAR PTR BCD_CLEAR
00D9 E99400                205                             JMP UPDATE_7SEG
                           206                             
00DC 803E74000C            207     BACKSPACE:      CMP DS:REG_AL, 12
00E1 7508                  208                             JNE ENTER_DATA
00E3 9A2002----     R      209                             CALL FAR PTR BCD_BACKSPACE
00E8 E98500                210                             JMP UPDATE_7SEG
                           211     
00EB 803E74000D            212     ENTER_DATA:     CMP DS:REG_AL, 13
00F0 7512                  213                             JNE QTY_PROMPT
00F2 C70697000800          214                             MOV DS:MAX_INPUT_SIZE, 8
00F8 EB7690                215                             JMP UPDATE_7SEG
                           216                             
00FB E99600                217     SUBTRACT2:   JMP SUBTRACT
                           218     
00FE E98300                219     KEYPAD3:        JMP KEYPAD_2
                           220     
0101 E99E00                221     RETURN2:    JMP RETURN
                           222     
0104                       223     QTY_PROMPT:
0104 833E610008            224                             CMP DS:KEYPAD_INDEX, 8
0109 7527                  225                             JNE  QUANTITY
010B 803E740016            226                             CMP DS:REG_AL, 22
0110 7520                  227                             JNE QUANTITY
0112 833E970008            228                             CMP DS:MAX_INPUT_SIZE, 8
0117 7519                  229                             JNE QUANTITY
0119 9AD901----     R      230                             CALL FAR PTR UPDATE_SEND_BUFFER
011E 9A5602----     R      231                             CALL FAR PTR BCD_CLEAR
0123 C70697000200          232                             MOV DS:MAX_INPUT_SIZE, 2
0129 C70699000100          233                             MOV DS:QTY_FLAG, 1
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    6


LOC  OBJ                  LINE     SOURCE

012F EB3F90                234                             JMP UPDATE_7SEG
                           235                     
0132                       236     QUANTITY:
0132 833E610000            237                             CMP DS:KEYPAD_INDEX, 0
0137 7437                  238                             JE  UPDATE_7SEG
                           239                             
0139 803E74000E            240                             CMP DS:REG_AL, 14
013E 7530                  241                             JNE UPDATE_7SEG
                           242                             
0140 833E990001            243                             CMP DS:QTY_FLAG, 1
0145 7529                  244                             JNE UPDATE_7SEG
                           245                             
0147 9AA701----     R      246                             CALL FAR PTR UPDATE_THE_QUANTITY
                           247                                             
014C C606870001            248                             MOV DS:SEND_FLAG, 1
0151 9AF802----     R      249                             CALL FAR PTR SEND_INPUT
0156 C70695000000          250                             MOV DS:SEND_BUFFER_LEN, 0
015C C70697000000          251                             MOV DS:MAX_INPUT_SIZE, 0
0162 C70699000000          252                             MOV DS:QTY_FLAG, 0
0168 9A5602----     R      253                             CALL FAR PTR BCD_CLEAR
                           254                                     
016D EB0190                255                             JMP UPDATE_7SEG
                           256                             
                           257     
0170                       258     UPDATE_7SEG:
0170 803E740009            259                             CMP DS:REG_AL, 9
0175 7F05                  260                             JG SET_PRESS_FLAG
                           261                             
0177 9A7B02----     R      262                             CALL FAR PTR BCD_UPDATE
                           263                             
017C                       264     SET_PRESS_FLAG:
017C C606780001            265                             MOV DS:LONG_PRESS_FLAG, 1
0181 EB1F90                266                             JMP RETURN
                           267             
0184                       268     KEYPAD_2: 
0184 800674000F            269                 ADD DS:REG_AL,0FH
0189 E900FF                270                             JMP NXTCOL
018C C606740000            271     ZERO_PRINT: MOV DS:REG_AL,00H
0191 E9F8FE                272                             JMP NXTCOL
0194 802E740006            273     SUBTRACT:   SUB DS:REG_AL,06H
0199 8ADD                  274                             MOV BL,CH
019B FE0E7500              275                             DEC DS:REG_BH
019F E9CEFE                276                             JMP NXTROW
                           277             
                           278             
01A2                       279     RETURN:
01A2 5A                    280                             POP DX
01A3 59                    281                             POP CX
01A4 5B                    282                             POP BX
01A5 58                    283                             POP AX
01A6 CB                    284                             RET
                           285     
                           286     KEYPAD_LOOP ENDP
                           287     
01A7                       288     UPDATE_THE_QUANTITY PROC FAR
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    7


LOC  OBJ                  LINE     SOURCE

01A7 50                    289     PUSH AX
01A8 53                    290     PUSH BX
01A9 51                    291     PUSH CX
01AA 52                    292     PUSH DX
01AB 8B0E6100              293             MOV CX, DS:KEYPAD_INDEX
01AF 8B1E9500              294             MOV BX, DS:SEND_BUFFER_LEN
                           295             
01B3                       296             UPD_QTY:
01B3 53                    297                     PUSH BX
01B4 8B1E6100              298                     MOV BX, DS:KEYPAD_INDEX
01B8 2BD9                  299                     SUB BX, CX
01BA 8A4751                300                     MOV AL, DS:KEYPAD_INPUT[BX]
01BD 5B                    301                     POP BX
01BE 0430                  302                     ADD AL, 30H
01C0 88878800              303                     MOV DS:SEND_BUFFER[BX], AL
                           304                     
01C4 43                    305                     INC BX
01C5 FF069500              306                     INC DS:SEND_BUFFER_LEN
                           307                     
01C9 E2E8                  308             LOOP UPD_QTY
01CB C68788002F            309                     MOV DS:SEND_BUFFER[BX], '/'
01D0 FF069500              310                     INC DS:SEND_BUFFER_LEN
                           311     
01D4 5A                    312     POP DX
01D5 59                    313     POP CX
01D6 5B                    314     POP BX
01D7 58                    315     POP AX
                           316     
01D8 CB                    317     RET
                           318     UPDATE_THE_QUANTITY ENDP
                           319     
01D9                       320     UPDATE_SEND_BUFFER PROC FAR
01D9 50                    321     PUSH AX
01DA 53                    322     PUSH BX
01DB 51                    323     PUSH CX
01DC 52                    324     PUSH DX
                           325     
01DD 8B0E6100              326             MOV CX, DS:KEYPAD_INDEX
01E1 83F900                327             CMP CX, 0
01E4 7435                  328             JE END_UPD_BUFFER
01E6 83C102                329             ADD CX, 2
01E9 890E9500              330             MOV DS:SEND_BUFFER_LEN, CX
01ED BB0000                331             MOV BX, 0
01F0                       332             BUFFER_LOOP:
01F0 83FB00                333                     CMP BX, 0
01F3 7508                  334                     JNE ASTRISK
01F5 C68788007E            335                     MOV DS:SEND_BUFFER[BX], '~'
01FA EB1C90                336                     JMP END_BUFFER
01FD                       337             ASTRISK:
01FD A16100                338                     MOV AX, DS:KEYPAD_INDEX
0200 40                    339                     INC AX
0201 3BD8                  340                     CMP BX, AX
0203 7508                  341                     JNE CONT
0205 C68788002A            342                     MOV DS:SEND_BUFFER[BX], '*'
020A EB0C90                343                     JMP END_BUFFER
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    8


LOC  OBJ                  LINE     SOURCE

020D                       344             CONT:
020D 4B                    345                     DEC BX
020E 8A4751                346                     MOV AL, DS:KEYPAD_INPUT[BX]
0211 0430                  347                     ADD AL, 30H
0213 43                    348                     INC BX
0214 88878800              349                     MOV DS:SEND_BUFFER[BX], AL
                           350                     
0218                       351             END_BUFFER:
0218 43                    352                     INC BX
0219 E2D5                  353             LOOP BUFFER_LOOP
021B                       354     END_UPD_BUFFER:
021B 5A                    355     POP DX
021C 59                    356     POP CX
021D 5B                    357     POP BX
021E 58                    358     POP AX
021F CB                    359     RET
                           360     UPDATE_SEND_BUFFER ENDP
                           361     
0220                       362     BCD_BACKSPACE PROC FAR
                           363     
0220 50                    364     PUSH AX
0221 53                    365     PUSH BX
0222 51                    366     PUSH CX
0223 52                    367     PUSH DX
                           368     
0224 8A167400              369             MOV DL, DS:REG_AL
0228 833E610000            370             CMP DS:KEYPAD_INDEX, 0
022D 7422                  371             JE RETURN_BACK
                           372             
022F BB0600                373             MOV BX, 6
0232                       374             BCD_CLEAR_LOOP:
0232 4B                    375                     DEC BX
0233 C647592D              376                     MOV DS:BCD_MESSAGE[BX], '-'
0237 43                    377                     INC BX
0238 4B                    378                     DEC BX
0239 75F7                  379             JNZ BCD_CLEAR_LOOP
                           380             
023B FF0E6100              381             DEC DS:KEYPAD_INDEX
023F C60674002D            382             MOV DS:REG_AL, '-'
0244 9A7B02----     R      383             CALL FAR PTR BCD_UPDATE
0249 FF0E6100              384             DEC DS:KEYPAD_INDEX
                           385             
024D 88167400              386             MOV DS:REG_AL, DL
0251                       387     RETURN_BACK:
0251 5A                    388     POP DX
0252 59                    389     POP CX
0253 5B                    390     POP BX
0254 58                    391     POP AX
                           392     
0255 CB                    393     RET
                           394     BCD_BACKSPACE ENDP
                           395     
0256                       396     BCD_CLEAR PROC FAR
0256 50                    397     PUSH AX
0257 53                    398     PUSH BX
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE    9


LOC  OBJ                  LINE     SOURCE

0258 51                    399     PUSH CX
0259 52                    400     PUSH DX
025A BB0800                401             MOV BX, 8
025D                       402             CLEAR_LOOP:
025D C6475100              403             MOV DS:KEYPAD_INPUT[BX], 0
0261 4B                    404             DEC BX
0262 75F9                  405             JNZ CLEAR_LOOP
                           406             
0264 BB0600                407             MOV BX, 6
0267                       408             CLEAR_LOOP2:
0267 4B                    409                     DEC BX
0268 C647592D              410                     MOV DS:BCD_MESSAGE[BX], '-'
026C 43                    411                     INC BX
026D 4B                    412                     DEC BX
026E 75F7                  413             JNZ CLEAR_LOOP2
                           414     
0270 C70661000000          415             MOV DS:KEYPAD_INDEX, 0
0276 5A                    416     POP DX
0277 59                    417     POP CX
0278 5B                    418     POP BX
0279 58                    419     POP AX
027A CB                    420     RET
                           421     BCD_CLEAR ENDP
                           422     
027B                       423     BCD_UPDATE PROC FAR
027B 50                    424     PUSH AX
027C 53                    425     PUSH BX
027D 51                    426     PUSH CX
027E 52                    427     PUSH DX
027F A19700                428                     MOV AX, DS:MAX_INPUT_SIZE
0282 39066100              429                     CMP DS:KEYPAD_INDEX, AX
0286 7448                  430                     JE BCD_RET
                           431                     
0288 8A0E7400              432                     MOV CL, DS:REG_AL
028C 80F909                433                     CMP CL, 9
028F 7F05                  434                     JG SKIP_PAST
0291 9AD502----     R      435                     CALL FAR PTR DAC_UPDATE
                           436     
0296                       437     SKIP_PAST:              
0296 8A0E7400              438                     MOV CL, DS:REG_AL
                           439     
029A 8B1E6100              440                     MOV BX, DS:KEYPAD_INDEX
                           441                             
029E 884F51                442                     MOV DS:KEYPAD_INPUT[BX], CL
                           443                             
02A1 FF066100              444                     INC DS:KEYPAD_INDEX
                           445                             
02A5 8B1E6100              446                     MOV BX, DS:KEYPAD_INDEX
02A9 8BD3                  447                     MOV DX, BX
02AB 83FA06                448                     CMP DX, 6
02AE 7E03                  449                     JLE update_display
02B0 BA0600                450                     MOV DX, 6
                           451                     
02B3                       452             update_display:
                           453                             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   10


LOC  OBJ                  LINE     SOURCE

02B3 B90500                454                     MOV CX, 5
02B6 4B                    455                     DEC BX
02B7 8A4751                456                     MOV AL, DS:KEYPAD_INPUT[BX]
02BA 43                    457                     INC BX
                           458                             
02BB 52                    459                     PUSH DX
02BC 8B166100              460                     MOV DX, DS:KEYPAD_INDEX
02C0 2BD3                  461                     SUB DX, BX
                           462                             
02C2 53                    463                     PUSH BX
                           464                             
02C3 2BCA                  465                     SUB CX, DX
02C5 8BD9                  466                     MOV BX, CX
02C7 884759                467                     MOV DS:BCD_MESSAGE[BX], AL
                           468                             
02CA 5B                    469                     POP BX
02CB 5A                    470                     POP DX
                           471             
02CC 4B                    472                     DEC BX
02CD 4A                    473                     DEC DX
02CE 75E3                  474                     JNZ update_display
                           475     
02D0                       476             BCD_RET:
02D0 5A                    477                     POP DX
02D1 59                    478                     POP CX
02D2 5B                    479                     POP BX
02D3 58                    480                     POP AX
02D4 CB                    481     RET
                           482     BCD_UPDATE ENDP
                           483     
02D5                       484     DAC_UPDATE PROC FAR
02D5 50                    485             PUSH AX
02D6 53                    486             PUSH BX
02D7 51                    487             PUSH CX
02D8 52                    488             PUSH DX
                           489             
02D9 BB0000                490             MOV BX, 0
02DC 8A1E7000              491             MOV BL, DS:DAC_LEN
02E0 A07400                492             MOV AL, DS:REG_AL
                           493             
02E3 884766                494             MOV DS:DAC_ADDR[BX], AL
                           495             
02E6 FE067000              496             INC DS:DAC_LEN
                           497     
02EA 5A                    498             POP DX
02EB 59                    499             POP CX
02EC 5B                    500             POP BX
02ED 58                    501             POP AX
02EE CB                    502     RET
                           503     DAC_UPDATE ENDP
                           504               
02EF                       505     DEBOUNCE PROC FAR
02EF 51                    506                       PUSH CX
                           507                       
02F0 B94C09                508                       MOV CX, 094CH
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   11


LOC  OBJ                  LINE     SOURCE

02F3 90                    509     BACK:     NOP
02F4 E2FD                  510                       LOOP BACK
02F6 59                    511                       POP CX
02F7 CB                    512                       RET
                           513     DEBOUNCE  ENDP
                           514     
02F8                       515     SEND_INPUT PROC FAR
02F8 50                    516     PUSH AX
02F9 53                    517     PUSH BX
02FA 51                    518     PUSH CX
02FB 52                    519     PUSH DX
02FC BB0000                520             MOV BX, 0
02FF 8B0E9500              521             MOV CX, DS:SEND_BUFFER_LEN
                           522             
0303                       523             S_BUFF:
0303 8A878800              524                     MOV AL, DS:SEND_BUFFER[BX]
0307 9A0000----     E      525                     CALL FAR PTR PRINT_CHAR
030C 43                    526                     INC BX
030D E2F4                  527             LOOP S_BUFF
                           528             
030F                       529     SEND_INPUT_END:
030F 5A                    530     POP DX
0310 59                    531     POP CX
0311 5B                    532     POP BX
0312 58                    533     POP AX
0313 CB                    534     RET
                           535     SEND_INPUT ENDP
                           536     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
0314                       537     SERIAL_REC_ACTION       PROC    FAR
0314 51                    538                     PUSH    CX
0315 53                    539                     PUSH    BX
0316 1E                    540                     PUSH    DS
                           541                     
0317 BB----         R      542                     MOV     BX,DATA_SEG             ;initialize data segment register
031A 8EDB                  543                     MOV     DS,BX
                           544                     
031C 803E860001            545                     CMP DS:REPLY_FLAG, 1
0321 7547                  546                     JNE next_id
0323 3C2F                  547                     CMP AL, '/'
0325 741B                  548                     JE reply
                           549                     
0327 803E870000            550                     CMP DS:SEND_FLAG, 0
032C 7439                  551                     JE id_skip2
                           552                     
032E 833E610000            553                     CMP DS:KEYPAD_INDEX, 0
0333 7432                  554                     JE id_skip2
                           555                     
0335 9AF802----     R      556                     CALL FAR PTR SEND_INPUT
033A C606870000            557                     MOV DS:SEND_FLAG, 0
                           558                     
033F EB2690                559                     JMP id_skip2
                           560                     
0342                       561             reply:
0342 33DB                  562                     XOR BX,BX
0344                       563             start_send:
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   12


LOC  OBJ                  LINE     SOURCE

0344 33C0                  564                     XOR AX,AX
0346 8A477D                565                     MOV AL, DS:REPLY_MESSAGE[BX]
0349 9A0000----     E      566                     CALL FAR PTR PRINT_CHAR
034E 43                    567                     INC BX
034F 3A1E8400              568                     CMP BL, DS:REPLY_COUNT
0353 75EF                  569                     JNE start_send
                           570                     
0355 C606860000            571                     MOV DS:REPLY_FLAG, 0
035A C6067C0000            572                     MOV DS:ID_FLAG_r, 0
035F C6067B0000            573                     MOV DS:ID_FLAG_@, 0
0364 E99B00                574                     JMP S_RET
                           575             
0367                       576             id_skip2:
0367 EB5E90                577                     JMP id_skip
                           578                     
036A                       579             next_id:
                           580                     
036A 803E7C0001            581                     CMP DS:ID_FLAG_r, 1
036F 7512                  582                     JNE id_flag_label
0371 38067A00              583                     CMP DS:MY_ID[1], AL
0375 7529                  584                     JNE id_not_equal
                           585                     ;start writing to pc
0377 FE068600              586                     INC DS:REPLY_FLAG
037B C6067C0000            587                     MOV DS:ID_FLAG_r, 0
0380 EB4590                588                     JMP id_skip
                           589                     
0383                       590             id_flag_label:
                           591             
0383 803E7B0001            592                     CMP DS:ID_FLAG_@, 1
0388 752F                  593                     JNE protocol_rec
038A 3C72                  594                     CMP AL,'r'
038C 750A                  595                     JNE id_not_r
038E BA0100                596                     MOV DX, 1
0391 88167C00              597                     MOV DS:ID_FLAG_r,DL
0395 EB6B90                598                     JMP S_RET
0398                       599             id_not_r:
0398 C6067B0000            600                     MOV DS:ID_FLAG_@, 0
039D EB2890                601                     JMP id_skip
                           602             
03A0                       603             id_not_equal:
03A0 C6067C0000            604                     MOV DS:ID_FLAG_r, 0
03A5 33DB                  605                     XOR BX,BX
03A7                       606             start_send1:
03A7 33C0                  607                     XOR AX,AX
03A9 8A878100              608                     MOV AL, DS:FAIL_MESSAGE[BX]
03AD 9A0000----     E      609                     CALL FAR PTR PRINT_CHAR
03B2 43                    610                     INC BX
03B3 3A1E8500              611                     CMP BL, DS:FAIL_COUNT
03B7 75EE                  612                     JNE start_send1
                           613                     
03B9                       614             protocol_rec:
03B9 3C40                  615                     CMP AL,'@'
03BB 750A                  616                     JNE id_skip
03BD BA0100                617                     MOV DX, 1
03C0 88167B00              618                     MOV DS:ID_FLAG_@,DL
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   13


LOC  OBJ                  LINE     SOURCE

03C4 EB3C90                619                     JMP S_RET
                           620                     
03C7                       621             id_skip:
                           622             
03C7 3C7E                  623                     CMP AL, '~'
03C9 7503                  624                     JNE resume
                           625                     
                           626                     ;CALL FAR PTR CLEAR_LCD
03CB EB3590                627                     JMP S_RET
                           628                     
03CE                       629                     resume:
                           630                     ;CALL FAR PTR UPDATE_LCD_INPUT
                           631                     
03CE                       632                     continue3:
                           633                     
03CE 3C3C                  634                     CMP     AL,'<'
03D0 750B                  635                     JNE     S_FAST
                           636     
03D2 FE061700              637                     INC     DS:T_COUNT_SET
03D6 FE061700              638                     INC     DS:T_COUNT_SET
                           639     
03DA EB0D90                640                     JMP     S_NEXT0
03DD                       641     S_FAST:
03DD 3C3E                  642                     CMP     AL,'>'
03DF 7521                  643                     JNE     S_RET
                           644     
03E1 FE0E1700              645                     DEC     DS:T_COUNT_SET
03E5 FE0E1700              646                     DEC     DS:T_COUNT_SET
                           647     
03E9                       648     S_NEXT0:
03E9 B91600                649                     MOV     CX,22                   ;initialize counter for message
03EC BB0000                650                     MOV     BX,0
                           651     
03EF 8A4718                652     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
03F2 9A0000----     E      653                     call    FAR ptr print_char
03F7 43                    654                     INC     BX
03F8 E2F5                  655                     LOOP    S_NEXT1
                           656     
03FA A01700                657                     MOV     AL,DS:T_COUNT_SET       ;print current period of timer0
03FD 9A0000----     E      658                     CALL    FAR PTR PRINT_2HEX
0402                       659     S_RET:
0402 1F                    660                     POP     DS
0403 5B                    661                     POP     BX
0404 59                    662                     POP     CX
0405 CB                    663                     RET
                           664     SERIAL_REC_ACTION       ENDP
                           665     
0406                       666     TIMER2_ACTION   PROC    FAR
0406 50                    667                     PUSH    AX
0407 1E                    668                     PUSH    DS
0408 53                    669                     PUSH    BX
0409 51                    670                     PUSH    CX
040A 52                    671                     PUSH    DX
                           672                     
                           673                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   14


LOC  OBJ                  LINE     SOURCE

040B B8----         R      674                     MOV     AX,DATA_SEG
040E 8ED8                  675                     MOV     DS,AX
                           676             
0410 FE0E1600              677                     DEC     DS:T_COUNT
0414 7538                  678                     JNZ     T_NEXT1
0416 A01700                679                     MOV     AL,DS:T_COUNT_SET
0419 A21600                680                     MOV     DS:T_COUNT,AL
                           681     
041C                       682     T_NEXT0:
041C A05F00                683                     MOV AL, DS:ENABLE_BYTE
041F BA8001                684                     MOV DX, 180H
0422 EE                    685                     OUT DX, AL
                           686                     
0423 33DB                  687                     XOR BX, BX
0425 8A1E6000              688                     MOV BL, DS:BCD_INDEX
0429 8A4759                689                     MOV AL, DS:BCD_MESSAGE[BX]
                           690             
042C 9ABF04----     R      691                     CALL FAR PTR BCD_TO_7SEG
                           692     
0431 BA0002                693                     MOV DX, 200H
0434 EE                    694                     OUT DX, AL
                           695     
0435 FE066000              696                     INC DS:BCD_INDEX
0439 D0065F00              697                     ROL DS:ENABLE_BYTE, 1
043D 803E5F00BF            698                     CMP DS:ENABLE_BYTE, 10111111b
0442 750A                  699                     JNE T_NEXT1
0444 C6065F00FE            700                     MOV DS:ENABLE_BYTE, 11111110b 
0449 C606600000            701                     MOV DS:BCD_INDEX, 0
                           702     
                           703                     
044E                       704     T_NEXT1:
044E 803E700000            705                     CMP DS:DAC_LEN, 0
0453 743C                  706                     JE ISR_END
                           707                     
                           708                     
0455 8B367100              709                     MOV SI, DS:SI_PTR
                           710                             
0459 BB0000                711                     MOV BX, 0
045C 33C0                  712                     XOR AX, AX
045E 8A4766                713                     MOV AL, DS:DAC_ADDR[BX]
                           714                     
0461 BB0001                715                     MOV BX, 100H
0464 F7E3                  716                     MUL BX
                           717                     
0466 8B166400              718                     MOV DX, DS:DAC_BASE
046A 03D0                  719                     ADD DX, AX
                           720                     
046C 1E                    721                     PUSH DS
046D 8EDA                  722                     MOV DS, DX
                           723                     
046F 8B04                  724                     MOV AX, [SI]
                           725                     
0471 BA1001                726                     MOV DX, 110H
0474 EE                    727                     OUT DX, AL
                           728                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   15


LOC  OBJ                  LINE     SOURCE

0475 1F                    729                     POP DS
                           730                     
0476 FF067100              731                     INC DS:SI_PTR
047A 813E71000010          732                     CMP DS:SI_PTR, 1000H
0480 750F                  733                     JNE ISR_END
                           734                     
0482 C70671000000          735                     MOV DS:SI_PTR, 0
0488 FE0E7000              736                     DEC DS:DAC_LEN
048C 9A9704----     R      737                     CALL FAR PTR DAC_SHIFT
                           738                     
0491                       739     ISR_END:
                           740                     
0491 5A                    741                     POP DX
0492 59                    742                     POP     CX
0493 5B                    743                     POP     BX
0494 1F                    744                     POP     DS
0495 58                    745                     POP AX
0496 CB                    746                     RET
                           747     TIMER2_ACTION   ENDP
                           748     
                           749     
0497                       750     DAC_SHIFT PROC FAR
0497 50                    751             PUSH AX
0498 53                    752             PUSH BX
0499 51                    753             PUSH CX
049A 52                    754             PUSH DX
                           755     
049B 33C9                  756             XOR CX, CX
049D 8A0E7000              757             MOV CL, DS:DAC_LEN
04A1 80F900                758             CMP CL, 0
04A4 7414                  759             JE END_SHIFT
                           760     
04A6                       761             SHIFT_LOOP:
                           762     
04A6 33DB                  763             XOR BX, BX
04A8 8A1E7000              764             MOV BL, DS:DAC_LEN
04AC 2BD9                  765             SUB BX, CX
04AE 43                    766             INC BX
                           767             
04AF 33D2                  768             XOR DX, DX
04B1 8A5766                769             MOV DL, DS:DAC_ADDR[BX]
04B4 4B                    770             DEC BX
04B5 885766                771             MOV DS:DAC_ADDR[BX], DL
                           772     
04B8 E2EC                  773             LOOP SHIFT_LOOP
                           774             
04BA                       775             END_SHIFT:
04BA 5A                    776             POP DX
04BB 59                    777             POP CX
04BC 5B                    778             POP BX
04BD 58                    779             POP AX
04BE CB                    780             RET
                           781     DAC_SHIFT ENDP
                           782     
04BF                       783     BCD_TO_7SEG PROC FAR
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   16


LOC  OBJ                  LINE     SOURCE

                           784     
04BF 53                    785             PUSH BX
04C0 51                    786             PUSH CX
04C1 52                    787             PUSH DX
                           788     
04C2 3C00                  789             CMP AL, 0
04C4 7505                  790             JNE one
04C6 B03F                  791             MOV AL, 00111111b;
04C8 EB5B90                792             JMP endfunc
                           793             
04CB                       794             one:
04CB 3C01                  795             CMP AL, 1
04CD 7505                  796             JNE two
04CF B006                  797             MOV AL, 00000110b;
04D1 EB5290                798             JMP endfunc
                           799             
04D4                       800             two:
04D4 3C02                  801             CMP AL,2
04D6 7505                  802             JNE three
04D8 B05B                  803             MOV AL, 01011011b;
04DA EB4990                804             JMP endfunc
                           805             
04DD                       806             three:
04DD 3C03                  807             CMP AL,3
04DF 7505                  808             JNE four
04E1 B04F                  809             MOV AL, 01001111b;
04E3 EB4090                810             JMP endfunc
                           811             
04E6                       812             four:
04E6 3C04                  813             CMP AL,4
04E8 7505                  814             JNE five
04EA B066                  815             MOV AL, 01100110b;
04EC EB3790                816             JMP endfunc
                           817             
04EF                       818             five:
04EF 3C05                  819             CMP AL,5
04F1 7505                  820             JNE six
04F3 B06D                  821             MOV AL, 01101101b;
04F5 EB2E90                822             JMP endfunc
                           823             
04F8                       824             six:
04F8 3C06                  825             CMP AL,6
04FA 7505                  826             JNE seven
04FC B07D                  827             MOV AL, 01111101b;
04FE EB2590                828             JMP endfunc
                           829             
0501                       830             seven:
0501 3C07                  831             CMP AL,7
0503 7505                  832             JNE eight
0505 B007                  833             MOV AL, 00000111b;
0507 EB1C90                834             JMP endfunc
                           835             
050A                       836             eight:
050A 3C08                  837             CMP AL,8
050C 7505                  838             JNE nine
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    16:25:33  11/15/;3  PAGE   17


LOC  OBJ                  LINE     SOURCE

050E B07F                  839             MOV AL, 01111111b;
0510 EB1390                840             JMP endfunc
                           841             
0513                       842             nine:
0513 3C09                  843             CMP AL,9
0515 7505                  844             JNE hifn
0517 B06F                  845             MOV AL, 01101111b;
0519 EB0A90                846             JMP endfunc
                           847             
051C                       848             hifn:
051C 3C2D                  849             CMP AL,'-'
051E 7505                  850             JNE endfunc
0520 B040                  851             MOV AL, 01000000b;
0522 EB0190                852             JMP endfunc
                           853             
0525                       854             endfunc:
0525 5A                    855             POP DX
0526 59                    856             POP CX
0527 5B                    857             POP BX
                           858     
0528 CB                    859     RET
                           860     BCD_TO_7SEG ENDP
                           861     
----                       862     CODE_SEG        ENDS
                           863     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
