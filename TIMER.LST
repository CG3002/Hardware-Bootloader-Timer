8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:54:57  10/14/;3  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  D:\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far
                            19     extrn   LCD_INIT:far, MESSAGE_LCD:far, CLEAR_LCD:far, UPDATE_LCD_INPUT:far
                            20     extrn   set_timer2:far
                            21     
                            22     ;IO Setup for 80C188 
  FFA0                      23             UMCR    EQU    0FFA0H ; Upper Memory Control Register
  FFA2                      24             LMCR    EQU    0FFA2H ; Lower Memory control Register         
  FFA4                      25             PCSBA   EQU    0FFA4H ; Peripheral Chip Select Base Address
  FFA8                      26             MPCS    EQU    0FFA8H ; MMCS and PCS Alter Control Register
  0080                      27             A_8255  EQU    0080H
  0081                      28             B_8255  EQU    0081H
  0082                      29             C_8255  EQU    0082H
  0083                      30             CWR_8255  EQU    0083H
  FF38                      31             INT0CON  EQU   0FF38H
  FF22                      32             EOI EQU 0FF22H
  FF28                      33             IMASK EQU 0FF28H
                            34     
----                        35     STACK_SEG       SEGMENT
0000 (256                   36                     DB      256 DUP(?)
     ??
     )
0100                        37             TOS     LABEL   WORD
----                        38     STACK_SEG       ENDS
                            39     
                            40     
----                        41     DATA_SEG        SEGMENT
0000 0A                     42             TIMER0_MESS     DB      10,13,'TIMER2 INTERRUPT    '
0001 0D
0002 54494D45523220
     494E5445525255
     505420202020
0016 2F                     43             T_COUNT         DB      2FH
0017 2F                     44             T_COUNT_SET     DB      2FH
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:54:57  10/14/;3  PAGE    2


LOC  OBJ                  LINE     SOURCE

0018 0A                     45             REC_MESS        DB      10,13,'Period of timer0 =     '
0019 0D
001A 506572696F6420
     6F662074696D65
     7230203D202020
     2020
0031 (32                    46             MESSAGE     DB  32 dup('h')
     68
     )
0051 20                     47             M_SIZE          DB  32
0052 00                     48             FLAG            DB  0
0053 ??                     49             CHAR            DB  ?
----                        50     DATA_SEG        ENDS
                            51     
                            52     
----                        53     CODE_SEG        SEGMENT
                            54     
                            55             PUBLIC          START
                            56     
                            57     ASSUME  CS:CODE_SEG, SS:STACK_SEG
                            58     
0000                        59     START:
                            60     ;initialize stack area
0000 B8----         R       61                     MOV     AX,STACK_SEG            
0003 8ED0                   62                     MOV     SS,AX
0005 368B260001             63                     MOV     SP,TOS
                            64     
                            65     ; Initialize the on-chip pheripherals
000A 9A0000----     E       66                     CALL    FAR PTR IODEFINE
                            67                     
                            68     ;call set_timer2
000F FB                     69                      STI
                            70     
                            71     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
                            72        
                            73     ; Initialize MPCS to MAP peripheral to IO address
                            74             
0010 BAA8FF                 75             MOV DX, MPCS
0013 B88300                 76             MOV AX, 0083H
0016 EF                     77             OUT DX, AX
                            78     
                            79     ; PCSBA initial, set the parallel port start from 00H
0017 BAA4FF                 80             MOV DX, PCSBA
001A B80300                 81             MOV AX, 0003H ; Peripheral starting address 00H no READY, No Waits
001D EF                     82             OUT DX, AX
                            83     
                            84     ; Initialize LMCS 
001E BAA2FF                 85         MOV DX, LMCR
0021 B8C401                 86         MOV AX, 01C4H  ; Starting address 1FFFH, 8K, No waits, last shoud be 5H for 1 wai
                                   ts      
0024 EF                     87         OUT DX, AX
                            88     
0025 B8----         R       89             MOV AX, DATA_SEG
0028 8ED8                   90             MOV DS, AX
                            91                              
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:54:57  10/14/;3  PAGE    3


LOC  OBJ                  LINE     SOURCE

002A BA8300                 92             MOV DX, CWR_8255
002D B88000                 93             MOV AX, 0080h
0030 EF                     94             OUT DX, AX
                            95             
0031 BA8000                 96             MOV DX, A_8255
0034 B023                   97             MOV AL, 23h
0036 F6D0                   98             NOT AL
0038 EE                     99             OUT DX, AL
                           100     
                           101             
0039 9A0000----     E      102             CALL FAR PTR LCD_INIT
                           103             
003E                       104     NEXT:
                           105             ; Begin 
                           106             
003E 9A0000----     E      107             CALL FAR PTR MESSAGE_LCD
                           108             
                           109             
0043 EBF9                  110     JMP NEXT
                           111     
                           112     
                           113     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
0045                       114     SERIAL_REC_ACTION       PROC    FAR
0045 51                    115                     PUSH    CX
0046 53                    116                     PUSH    BX
0047 1E                    117                     PUSH    DS
                           118                     
0048 BB----         R      119                     MOV     BX,DATA_SEG             ;initialize data segment register
004B 8EDB                  120                     MOV     DS,BX
                           121                     
004D 3C7E                  122                     CMP AL, '~'
004F 7508                  123                     JNE resume
                           124                     
0051 9A0000----     E      125                     CALL FAR PTR CLEAR_LCD
0056 EB3A90                126                     JMP S_RET
                           127                     
0059                       128                     resume:
0059 9A0000----     E      129                     CALL FAR PTR UPDATE_LCD_INPUT
                           130                     
005E                       131                     continue3:
                           132                     
005E 3C3C                  133                     CMP     AL,'<'
0060 750B                  134                     JNE     S_FAST
                           135     
0062 FE061700              136                     INC     DS:T_COUNT_SET
0066 FE061700              137                     INC     DS:T_COUNT_SET
                           138     
006A EB0D90                139                     JMP     S_NEXT0
006D                       140     S_FAST:
006D 3C3E                  141                     CMP     AL,'>'
006F 7521                  142                     JNE     S_RET
                           143     
0071 FE0E1700              144                     DEC     DS:T_COUNT_SET
0075 FE0E1700              145                     DEC     DS:T_COUNT_SET
                           146     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    11:54:57  10/14/;3  PAGE    4


LOC  OBJ                  LINE     SOURCE

0079                       147     S_NEXT0:
0079 B91600                148                     MOV     CX,22                   ;initialize counter for message
007C BB0000                149                     MOV     BX,0
                           150     
007F 8A4718                151     S_NEXT1:        MOV     AL,DS:REC_MESS[BX]      ;print message
0082 9A0000----     E      152                     call    FAR ptr print_char
0087 43                    153                     INC     BX
0088 E2F5                  154                     LOOP    S_NEXT1
                           155     
008A A01700                156                     MOV     AL,DS:T_COUNT_SET       ;print current period of timer0
008D 9A0000----     E      157                     CALL    FAR PTR PRINT_2HEX
0092                       158     S_RET:
0092 1F                    159                     POP     DS
0093 5B                    160                     POP     BX
0094 59                    161                     POP     CX
0095 CB                    162                     RET
                           163     SERIAL_REC_ACTION       ENDP
                           164     
                           165     
                           166     
0096                       167     TIMER2_ACTION   PROC    FAR
0096 50                    168                     PUSH    AX
0097 1E                    169                     PUSH    DS
0098 53                    170                     PUSH    BX
0099 51                    171                     PUSH    CX
                           172     
009A B8----         R      173                     MOV     AX,DATA_SEG
009D 8ED8                  174                     MOV     DS,AX
                           175             
009F FE0E1600              176                     DEC     DS:T_COUNT
00A3 7516                  177                     JNZ     T_NEXT1
00A5 A01700                178                     MOV     AL,DS:T_COUNT_SET
00A8 A21600                179                     MOV     DS:T_COUNT,AL
                           180     
00AB B91400                181                     MOV     CX,20
00AE BB0000                182                     MOV     BX,0H
00B1                       183     T_NEXT0:
00B1 8A07                  184                     MOV     AL,DS:TIMER0_MESS[BX]
00B3 43                    185                     INC     BX
00B4 9A0000----     E      186                     CALL    FAR PTR PRINT_CHAR
00B9 E2F6                  187                     LOOP    T_NEXT0
                           188     
00BB                       189     T_NEXT1:        
00BB 59                    190                     POP     CX
00BC 5B                    191                     POP     BX
00BD 1F                    192                     POP     DS
00BE 58                    193                     POP     AX
00BF CB                    194                     RET
                           195     TIMER2_ACTION   ENDP
                           196     
                           197     
----                       198     CODE_SEG        ENDS
                           199     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
